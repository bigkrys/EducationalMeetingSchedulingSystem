# æ•™è‚²è°ƒåº¦ç³»ç»Ÿè®¾è®¡è¯´æ˜

> æ³¨ï¼šæˆ‘ä¹‹æ‰€ä»¥é€‰æ‹©è¯¥é¡¹ç›®è¿›è¡Œå®è·µï¼Œæ˜¯æˆ‘æœ¬ç§‘æ¯•ä¸šè®¾è®¡é¡¹ç›®åšçš„â€œé€‰è¯¾ç³»ç»Ÿçš„è®¾è®¡ä¸å®è·µâ€ï¼Œä¸¤è€…åœ¨è®¾è®¡æ€æƒ³ä¸Šæœ‰å¯å¤ç”¨çš„ç¯èŠ‚ï¼Œä¸‹é¢å…ˆè¯¦ç»†è¯´æ˜æœ¬ç³»ç»Ÿçš„åŠŸèƒ½è®¾è®¡ã€‚
> 


# ä¸€ã€ ä¸šåŠ¡åŠŸèƒ½è¯´æ˜

> è¯¥ç³»ç»Ÿæ˜¯ç»™å­¦æ ¡ä½¿ç”¨çš„å¹³å°ã€‚å­¦ç”Ÿåœ¨å¹³å°é€‰æ‹©è€å¸ˆå’Œé¢„çº¦è¯¥è€å¸ˆçš„è¾…å¯¼ï¼Œè€å¸ˆåœ¨å¹³å°è®¾ç½®è‡ªå·±çš„å¯é¢„çº¦æ—¶é—´æ®µå¹¶å¯¹å­¦ç”Ÿé¢„çº¦è¿›è¡Œå®¡æ‰¹ï¼›ç³»ç»Ÿæ ¹æ®ä¸åŒçš„â€œæœåŠ¡çº§åˆ«â€è‡ªåŠ¨/äººå·¥æ‰¹å‡†ï¼Œé™åˆ¶æ¯æœˆæ¬¡æ•°ï¼Œå¹¶é¿å…å†²çªã€‚
> 

## 1.1 è§’è‰²ä¸æƒé™

- **å­¦ç”Ÿï¼ˆstudentï¼‰**ï¼šæŸ¥è¯¢è€å¸ˆåŠå…¶å¯ç”¨æ—¶æ®µã€å‘èµ·é¢„çº¦ã€æŸ¥çœ‹/å–æ¶ˆé¢„çº¦ã€æ¥æ”¶é€šçŸ¥ã€‚
- **æ•™å¸ˆï¼ˆteacherï¼‰**ï¼šé…ç½®å¯ç”¨æ—¶æ®µã€è®¾ç½®é˜»å¡æ—¶é—´ã€å®¡æ‰¹/æ‹’ç»é¢„çº¦ã€æŸ¥çœ‹è‡ªå·±çš„æ—¥ç¨‹ã€‚
- **ç®¡ç†å‘˜ï¼ˆadminï¼‰**ï¼šç®¡ç†æœåŠ¡çº§åˆ«ç­–ç•¥ã€é…é¢ã€é˜ˆå€¼ã€ç§‘ç›®ã€å…¨å±€è¿è¥æŠ¥è¡¨ã€å®¡è®¡æ—¥å¿—ã€‚

## 1.2 æœåŠ¡çº§åˆ«é€»è¾‘

- **Level1**ï¼šæ¯æœˆ 2 æ¬¡è‡ªåŠ¨æ‰¹å‡†ï¼Œé¢å¤–éœ€å®¡æ‰¹ã€‚
- **Level2**ï¼šæ‰€æœ‰ä¼šè®®å‡éœ€å®¡æ‰¹ã€‚
- **Premium**ï¼šå…¨éƒ¨è‡ªåŠ¨æ‰¹å‡†ï¼Œä¸”æœ‰ä¼˜å…ˆæƒã€‚
- **ç§‘ç›®é™åˆ¶**ï¼šå­¦ç”Ÿä»…èƒ½é¢„çº¦æ•™æˆå…¶**å·²æ³¨å†Œç§‘ç›®**çš„æ•™å¸ˆã€‚
- **æœˆåº¦é‡ç½®**ï¼šæ¯æœˆ 1 æ—¥é…é¢è®¡æ•°æ¸…é›¶ï¼ˆä»¥ç³»ç»Ÿæ—¶åŒºä¸ºå‡†ï¼‰

## 1.3 åŠŸèƒ½æ¸…å•ä¸è¯´æ˜

| è§’è‰² | åŠŸèƒ½ | è¯´æ˜ | å…³é”®è§„åˆ™ |
| --- | --- | --- | --- |
| å­¦ç”Ÿ | æœç´¢æ•™å¸ˆå¯ç”¨æ§½ä½ | æ ¹æ®æ•™å¸ˆä¸æ—¥æœŸè¿”å›å¯é¢„çº¦å¼€å§‹æ—¶é—´åˆ—è¡¨ | éµå®ˆ availabilityã€blockedã€appointmentsã€bufferï¼Œä¸è¶… maxDailyMeetings |
| å­¦ç”Ÿ | åˆ›å»ºé¢„çº¦ | å­¦ç”Ÿé€‰æ‹©æ§½ä½åˆ›å»ºé¢„çº¦ | ç§‘ç›®åŒ¹é…ã€æœåŠ¡çº§åˆ«è·¯ç”±ã€æ§½ä½å ç”¨æ£€æŸ¥ã€å¹‚ç­‰ |
| å­¦ç”Ÿ | å–æ¶ˆé¢„çº¦ | åœ¨å…è®¸çš„æ—¶é™å†…å–æ¶ˆï¼ˆä¾‹å¦‚ä¼šè®®å¼€å§‹å‰â‰¥2hï¼Œå¯é…ç½®ï¼‰ | å·²å®Œæˆ/å·²è¿‡æœŸä¸å¯å–æ¶ˆï¼›å†™å®¡è®¡ |
| å­¦ç”Ÿ | é¢„çº¦æ”¹æœŸ | å–å†³äºæ˜¯å¦æ”¯æŒâ€œç§»åŠ¨â€é¢„çº¦ï¼›é»˜è®¤å®ç°ä¸ºâ€œå–æ¶ˆ+æ–°å»ºâ€ | æ”¹æœŸéœ€é‡è¿‡å†²çªä¸é…é¢æ ¡éªŒ |
| å­¦ç”Ÿ | æŸ¥çœ‹æˆ‘çš„é¢„çº¦ | æŒ‰çŠ¶æ€/æ—¶é—´èŒƒå›´åˆ†é¡µæŸ¥è¯¢ | é»˜è®¤å‡åº |
| æ•™å¸ˆ | ç»´æŠ¤æ¯å‘¨å¯ç”¨æ€§ | è®¾ç½®/æ›´æ–° dayOfWeek + start/end | åŒä¸€å¤©å¯å¤šä¸ªåŒºé—´ |
| æ•™å¸ˆ | ç»´æŠ¤é˜»å¡æ—¶é—´ | è®°å½•ä¸€æ®µä¸å¯é¢„çº¦æ—¶é—´ï¼ˆä¸Šè¯¾/å¼€ä¼šç­‰ï¼‰ | ä¸é¢„çº¦å†²çªæ—¶æç¤ºé£é™© |
| æ•™å¸ˆ | å®¡æ‰¹/æ‹’ç»é¢„çº¦ | å¯¹æ‰€æœ‰pending æ‰§è¡Œ approve/cancel | è®°å½•åŸå› ã€æ—¶é—´ï¼›é€šçŸ¥ |
| ç®¡ç† | æœåŠ¡çº§åˆ«ç­–ç•¥ | é…é¢é˜ˆå€¼ã€è¶…æ—¶é˜ˆå€¼ã€æé†’ç­–ç•¥ç­‰å‚æ•°åŒ– | å¯åç»­æŠ½è±¡ä¸ºç­–ç•¥è¡¨ |
| ç³»ç»Ÿ | 48h å¾…å®¡æ‰¹è¿‡æœŸ | å®šæ—¶æ‰«æ pending è¶…æ—¶â†’expired | å‘é€è¿‡æœŸé€šçŸ¥ |
| ç³»ç»Ÿ | æœˆåˆé…é¢é‡ç½® | æ¯æœˆ1æ—¥é‡ç½® Level1/2 é…é¢è®¡æ•° | æ›´æ–°æ—¶é—´æˆ³ |
| ç³»ç»Ÿ | æé†’é€šçŸ¥ | T-24h / T-1h æé†’å­¦ç”Ÿ&æ•™å¸ˆ | é˜Ÿåˆ—/å®šæ—¶è§¦å‘ |
| ç³»ç»Ÿ | å€™è¡¥é˜Ÿåˆ— | è‹¥çƒ­é—¨æ—¶æ®µè¢«å ï¼Œå¯åŠ å…¥å€™è¡¥ï¼›é‡Šæ”¾æ—¶è‡ªåŠ¨é¡¶æ›¿ | é¡¶æ›¿åé€šçŸ¥åŒæ–¹ |

# äºŒã€ç³»ç»Ÿæ•´ä½“è®¾è®¡ä¸æ¶æ„

## 2.1 æ•´ä½“æ¶æ„

```mermaid
graph TD
  Client[Web/Mobile Client] -->|HTTPS/REST| API[Next.js API Routes]
  API --> Auth[Auth Service]
  API --> Scheduler[Scheduler Service]
  API --> Teacher[Teacher Service]
  API --> Admin[Admin Service]
  API --> Queue[Message Queue]
  Queue --> Mailer[Notification Service]
  API --> DB[(PostgreSQL)]
  API --> Cache[(Redis)]
```

**è¯´æ˜ï¼š**

- **Auth Service**ï¼šè´Ÿè´£ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€JWT æ ¡éªŒã€é‚€è¯·ç æ³¨å†Œã€‚
- **Scheduler Service**ï¼šè´Ÿè´£é¢„çº¦é€»è¾‘ï¼ˆå¯ç”¨æ§½ä½è®¡ç®—ã€å†²çªæ ¡éªŒã€é…é¢è¿½è¸ªã€å®¡æ‰¹å·¥ä½œæµï¼‰ã€‚
- **Teacher Service**ï¼šæ•™å¸ˆå¯ç”¨æ€§ã€é˜»å¡æ—¶é—´ã€å®¡æ‰¹ã€‚
- **Admin Service**ï¼šç­–ç•¥ç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€å®¡è®¡æŸ¥è¯¢ã€‚
- **Notification Service**ï¼šæé†’é€šçŸ¥ã€è¿‡æœŸé€šçŸ¥ã€‚
- **Database**ï¼šPostgreSQLï¼ŒåŒ…å«è®¤è¯è¡¨ã€ä¸šåŠ¡è¡¨ã€å®¡è®¡è¡¨ã€‚
- **Cache**ï¼šRedisï¼Œç¼“å­˜çƒ­é—¨æ§½ä½å’ŒæŸ¥è¯¢ç»“æœã€‚
- **Message Queue**ï¼šKafka/RabbitMQï¼Œå¤„ç†é€šçŸ¥ã€æ‰¹é‡ä»»åŠ¡ã€‚

# ä¸‰ã€æ¨¡å—è®¾è®¡

## **3.1 ç”¨æˆ·æ³¨å†Œä¸ç™»å½•æ¨¡å—**

### 3.1.1 å­¦ç”Ÿæ³¨å†Œ/ç™»å½•

**æ³¨å†Œæ­¥éª¤**

- è‡ªåŠ©æ³¨å†Œï¼šä»…å…è®¸åˆ›å»º `role=student`ã€‚
- è¡¨å•ï¼šemailã€passwordã€ï¼ˆå¯é€‰ï¼‰å§“åã€å¹´çº§ã€`enrolledSubjects` åˆå§‹åŒ–ã€‚
- æ ¡éªŒï¼šé‚®ç®±å”¯ä¸€+å¯†ç å¼ºåº¦ï¼›å†™å…¥ `users(status=pending)` ä¸ `students` æ‰©å±•è¡¨ï¼›å‘éªŒè¯é‚®ä»¶ã€‚
- æ¿€æ´»ï¼šç‚¹å‡»é‚®ä»¶é­”æ³•é“¾æ¥ â†’ `users.status=active`ã€‚

**ç™»å½•æ­¥éª¤**

- è¾“å…¥ email/password â†’ æ ¡éªŒ `users.status in ('active')` â†’ è¿”å› `accessToken(15min)` ä¸ `refreshToken(30d)`
- è®°å½• `last_login_at`ï¼Œå†™å®¡è®¡æ—¥å¿—ï¼ˆaction=loginï¼‰ã€‚

### 3.1.2 æ•™å¸ˆæ³¨å†Œ/ç™»å½•

**æ³¨å†Œæ­¥éª¤**

- æ¨èâ€œå—é‚€æ³¨å†Œâ€ï¼šç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜é¢„åˆ›å»ºâ€œæ•™å¸ˆé‚€è¯·â€ï¼ˆè§ 3.1.3ï¼‰ï¼Œæ•™å¸ˆé€šè¿‡é‚€è¯·é‚®ä»¶å®Œæˆæ³¨å†Œä¸æ¿€æ´»ã€‚
- ä¹Ÿå¯å¼€æ”¾â€œè‡ªåŠ©æ³¨å†Œâ€ä½†éœ€æ·»åŠ â€œäººå·¥å®¡æ ¸é€šè¿‡åç”Ÿæ•ˆâ€çš„å¼€å…³ï¼ˆæœºæ„å¯é…ç½®ï¼‰ï¼Œä»¥é˜²ä¼ªå†’æ•™å¸ˆã€‚

**ç™»å½•æ­¥éª¤**

- åŒå­¦ç”Ÿï¼›æ¿€æ´»åå¯ç™»å½•ï¼Œå®Œå–„ `subjects/maxDailyMeetings/bufferMinutes` ç­‰ã€‚

```mermaid
sequenceDiagram
participant U as User(å­¦ç”Ÿ/æ•™å¸ˆ)
participant W as WebApp
participant API as API Gateway
participant AUTH as AuthService
participant DB as DB
participant MAIL as MailService

U->>W: å¡«å†™é‚®ç®±+å¯†ç æäº¤æ³¨å†Œ
W->>API: POST /api/auth/register
API->>AUTH: æ ¡éªŒå”¯ä¸€æ€§/å¼ºåº¦
AUTH->>DB: æ–°å»º users(status=pending)
AUTH->>MAIL: å‘é€æ¿€æ´»é‚®ä»¶(ä¸€æ¬¡æ€§token)
U->>MAIL: ç‚¹å‡»æ¿€æ´»é“¾æ¥
MAIL->>AUTH: éªŒè¯token
AUTH->>DB: users.status=active
AUTH-->>W: æ³¨å†Œå®Œæˆ(å¯ç™»å½•)

U->>W: è¾“å…¥é‚®ç®±/å¯†ç ç™»å½•
W->>API: POST /api/auth/login
API->>AUTH: æ ¡éªŒå‡­æ®/çŠ¶æ€=active
AUTH->>DB: è®°å½•last_login_at/å†™åˆ·æ–°ä»¤ç‰Œ
AUTH-->>W: Set-Cookie(HttpOnly) Access(çŸ­) + Refresh(é•¿)

```

### 3.1.3 ç®¡ç†å‘˜ç™»å½•ï¼ˆå«è¶…çº§ç®¡ç†å‘˜å¼•å¯¼ï¼‰

**åˆå§‹åŒ–è¶…çº§ç®¡ç†å‘˜ï¼ˆä¸€æ¬¡æ€§ï¼‰**

- é¦–æ¬¡éƒ¨ç½²æ—¶ï¼Œé€šè¿‡â€œå¼•å¯¼å£ä»¤ï¼ˆenvï¼‰+å—æ§å…¥å£â€å®Œæˆè¶…çº§ç®¡ç†å‘˜ï¼ˆ`role=admin,is_super=true`ï¼‰åˆ›å»ºã€‚
- åˆ›å»ºæˆåŠŸå**è‡ªåŠ¨å¤±æ•ˆ**å¼•å¯¼å£ä»¤ï¼Œé¿å…é‡æ”¾ã€‚

**ç®¡ç†å‘˜åˆ›å»ºä¸æƒé™**

- ç®¡ç†å‘˜è´¦å·ä»…èƒ½ç”±**è¶…çº§ç®¡ç†å‘˜**åˆ›å»ºï¼ˆæˆ–å‘å‡ºâ€œç®¡ç†å‘˜é‚€è¯·â€ï¼‰ï¼›æ™®é€šç®¡ç†å‘˜ä¸å¯è‡ªåŠ©æ³¨å†Œã€‚
- ç®¡ç†å‘˜æ‹¥æœ‰åå°ç®¡ç†å…¥å£ï¼Œå¯ç®¡ç†ç­–ç•¥/ç”¨æˆ·ä¸å®¡è®¡ï¼Œä½†ä¸èƒ½è¶Šæƒææƒã€‚
- æ™®é€šç®¡ç†å‘˜ï¼šå¯ç™»å½•ä¸ä¿®æ”¹è‡ªå·±å¯†ç ï¼›**ä¸èƒ½**åˆ›å»ºæ–°ç®¡ç†å‘˜ã€‚

```mermaid
sequenceDiagram
participant OP as DevOps
participant API as API Gateway
participant AUTH as AuthService
participant DB as DB
participant MAIL as MailService
participant SA as SuperAdmin
participant ADM as Admin(è¢«é‚€è¯·è€…)

OP->>API: POST /api/admin/bootstrap {bootstrapSecret}
API->>AUTH: æ ¡éªŒå¼•å¯¼å£ä»¤(ä»…ä¸€æ¬¡)
AUTH->>DB: åˆ›å»º users(role=admin,is_super=true,active)
AUTH-->>OP: åˆå§‹åŒ–å®Œæˆ(å£ä»¤å¤±æ•ˆ)

SA->>API: POST /api/admin/users(invite admin)
API->>AUTH: ç”Ÿæˆadmin_invite_token
AUTH->>DB: å†™å…¥é‚€è¯·
AUTH->>MAIL: å‘é‚€è¯·é‚®ä»¶

ADM->>MAIL: ç‚¹å‡»é‚€è¯·é“¾æ¥
MAIL->>AUTH: éªŒè¯token
AUTH->>DB: åˆ›å»º users(role=admin,active)
AUTH-->>ADM: è®¾ç½®å¯†ç å¹¶ç™»å½•åå°

```

### 3.1.4 ç™»å½•/åˆ·æ–°/ç™»å‡º

```mermaid
sequenceDiagram
participant U as User
participant W as WebApp
participant API as API Gateway
participant AUTH as AuthService
participant DB as DB

U->>W: è¾“å…¥é‚®ç®±/å¯†ç 
W->>API: POST /api/auth/login
API->>AUTH: æ ¡éªŒå‡­æ®/çŠ¶æ€
AUTH->>DB: è®°å½•last_login/å†™refresh_token
AUTH-->>W: Set-Cookie Access(15m)+Refresh(30d)

Note over W: Accessè¿‡æœŸåé™é»˜åˆ·æ–°
W->>API: POST /api/auth/refresh (å¸¦Refresh Cookie)
API->>AUTH: éªŒè¯å¹¶è½®æ¢refresh_token
AUTH->>DB: æ—§refresh_token.revoked=trueï¼Œå†™æ–°token
AUTH-->>W: æ–°Access + æ–°Refresh(Set-Cookie)

U->>W: ç‚¹å‡»é€€å‡º
W->>API: POST /api/auth/logout
API->>AUTH: å½“å‰refresh_token.revoked=true
AUTH-->>W: 204 No Content

```

## 3.2 å­¦ç”Ÿï½œæœç´¢æ•™å¸ˆå¯ç”¨æ§½ä½

**ç›®æ ‡**ï¼šæ ¹æ®æ•™å¸ˆä¸æ—¥æœŸè¿”å›å¯é¢„çº¦å¼€å§‹æ—¶é—´åˆ—è¡¨ã€‚

**å…³é”®è§„åˆ™**ï¼šéµå®ˆ `availability`ã€`blocked_times`ã€`appointments`ã€`buffer`ï¼Œä¸è¶… `maxDailyMeetings`ã€‚

**æ­¥éª¤**ï¼š

1. å‰ç«¯æ”¶é›† `teacherId/date/duration` è°ƒç”¨ APIã€‚
2. æœåŠ¡å™¨å…ˆæŸ¥ç¼“å­˜ï¼›æœªå‘½ä¸­åˆ™ï¼š
    - è¯»æ•™å¸ˆå½“æ—¥ `availability`ï¼›
    - è¯»å½“æ—¥ `appointments(status in [pending,approved])`ï¼›
    - è¯» `blocked_times`ï¼›
    - è¯»å– `bufferMinutes/maxDailyMeetings`ï¼›
    - é€æ§½ä½åˆ‡ç‰‡å¹¶åš**åŒºé—´é‡å  + ç¼“å†²**æ£€æµ‹ï¼›
    - å¯æŒ‰ `maxDailyMeetings` æˆªæ–­ï¼›
    - å†™å…¥çŸ­æœŸç¼“å­˜è¿”å›ã€‚
3. å“åº” `slots[]`ï¼ˆUTCï¼‰ï¼Œå‰ç«¯æŒ‰ç”¨æˆ·æ—¶åŒºæ¸²æŸ“ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API (Slots)
participant C as Cache
participant D as DB
U->>W: é€‰æ‹© teacherId + date (+ duration)
W->>A: GET /api/slots?teacherId&date&duration
A->>C: GET slots:{tid}:{date}:{duration}
alt ç¼“å­˜å‘½ä¸­
C-->>A: è¿”å› slots[]
else æœªå‘½ä¸­
A->>D: è¯» availability/appointments/blocked_times/teacher
A->>A: åˆ‡ç‰‡ duration + buffer å†²çªæ£€æµ‹ + å½“æ—¥ä¸Šé™
A->>C: SET slots é”® (TTL 1-5m)
end
A-->>W: slots[] (ISO8601 UTC)
```

## 3.3 å­¦ç”Ÿï½œåˆ›å»ºé¢„çº¦

**ç›®æ ‡**ï¼šå­¦ç”Ÿé€‰æ‹©æ§½ä½åˆ›å»ºé¢„çº¦ã€‚

**å…³é”®è§„åˆ™**ï¼šç§‘ç›®åŒ¹é…ã€æœåŠ¡çº§åˆ«è·¯ç”±ã€æ§½ä½å ç”¨æ£€æŸ¥ã€å¹‚ç­‰ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒä¸»ä½“ï¼šå­¦ç”Ÿ/æ•™å¸ˆå­˜åœ¨ã€`subject` åŒæ—¶åŒ…å«äº `student.enrolledSubjects` ä¸ `teacher.subjects`ã€‚
2. **æ§½ä½å¯ç”¨æ€§**ï¼šå¯ç›´æ¥é‡è·‘ `generateAvailableSlots()` å¹¶æ ¡éªŒ `scheduledTime` åœ¨è¿”å›é›†å†…ï¼ˆè§„é¿å¹¶å‘ï¼‰ã€‚
3. **æœåŠ¡çº§åˆ«è·¯ç”±**ï¼š
    - Level1ï¼šè‹¥ `monthlyMeetingsUsed < 2` â†’ `approved`ï¼Œå¹¶åœ¨äº‹åŠ¡å†… +1ï¼›å¦åˆ™ `pending`ï¼›
    - Level2ï¼š`pending`ï¼›
    - Premiumï¼š`approved`ï¼ˆå¯é€‰ï¼šæŠ¢å ä½ä¼˜å…ˆçº§ `pending`ï¼‰ã€‚
4. **å¹‚ç­‰**ï¼šä½¿ç”¨ `idempotencyKey` å”¯ä¸€é”®ï¼›é‡å¤æäº¤è¿”å›å·²åˆ›å»ºè®°å½•ã€‚
5. **ç¼“å­˜å¤±æ•ˆ**ï¼šåˆ é™¤ç›¸å…³ `slots:{tid}:{date}:{duration}`ã€‚
6. **é€šçŸ¥**ï¼šæ ¹æ®ç»“æœå‘é€é‚®ä»¶ï¼ˆå·²æ‰¹æ ¸/ç­‰å¾…å®¡æ‰¹ï¼‰ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API (Appointments)
participant D as DB
participant C as Cache
participant E as Email
U->>W: é€‰æ‹©æ§½ä½å¹¶æäº¤
W->>A: POST /api/appointments {studentId,teacherId,subject,scheduledTime,duration,idempotencyKey}
A->>D: æ ¡éªŒå­¦ç”Ÿ/æ•™å¸ˆ/ç§‘ç›®åŒ¹é…
A->>A: æœåŠ¡çº§åˆ«å†³ç­– approved|pendingï¼ˆLevel1/2/Premiumï¼‰
A->>D: äº‹åŠ¡: å†™å…¥é¢„çº¦(+å¿…è¦æ—¶é€’å¢é…é¢)
A->>C: å¤±æ•ˆ slots ç¼“å­˜é”®
A->>E: å‘é€ç¡®è®¤/å¾…å®¡æ‰¹é€šçŸ¥(å¼‚æ­¥)
A-->>W: 201 {status, approvalRequired}
```

## 3.4 å­¦ç”Ÿï½œå–æ¶ˆé¢„çº¦

**ç›®æ ‡**ï¼šå…è®¸åœ¨ä¼šè®®å¼€å§‹å‰â‰¥2hï¼ˆå¯é…ç½®ï¼‰å–æ¶ˆã€‚

**å…³é”®è§„åˆ™**ï¼š`completed/expired` ä¸å¯å–æ¶ˆï¼›å†™å®¡è®¡ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒè¯·æ±‚è€…ä¸ºè¯¥é¢„çº¦çš„å­¦ç”Ÿï¼›
2. æ ¡éªŒ `now <= scheduledTime - cancelWindow(2h)`ï¼›
3. çŠ¶æ€å…è®¸ï¼š`pending|approved`ï¼›
4. æ›´æ–°ä¸º `cancelled`ï¼Œå†™å®¡è®¡ä¸å¯é€‰çš„å–æ¶ˆåŸå› ï¼›
5. å¤±æ•ˆæ§½ä½ç¼“å­˜ï¼›é€šçŸ¥ç›¸å…³æ•™å¸ˆã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API (Appointments)
participant D as DB
participant C as Cache
participant E as Email
U->>W: ç‚¹å‡»å–æ¶ˆ
W->>A: PATCH /api/appointments/{id} {action: cancel}
A->>D: è¯»å–é¢„çº¦å¹¶æ ¡éªŒæƒé™/æ—¶é—´çª—å£
A->>D: æ›´æ–°ä¸º cancelled, è®°å½•åŸå› 
A->>C: å¤±æ•ˆ slots ç¼“å­˜(æ‰€åœ¨æ—¥æœŸ/æ•™å¸ˆ)
A->>E: é€šçŸ¥æ•™å¸ˆ
A-->>W: 200 OK
```

## 3.5 å­¦ç”Ÿï½œé¢„çº¦æ”¹æœŸ

**ç›®æ ‡**ï¼šé»˜è®¤ä»¥â€œå–æ¶ˆ+æ–°å»ºâ€å®ç°ã€‚

**å…³é”®è§„åˆ™**ï¼šæ–°å»ºéœ€é‡æ–°é€šè¿‡**å†²çªä¸é…é¢**æ ¡éªŒã€‚

**æ­¥éª¤**ï¼š

1. å…ˆæŒ‰ **å–æ¶ˆ**è§„åˆ™å¤„ç†æ—§é¢„çº¦ï¼›
2. ä½¿ç”¨æ–°æ§½ä½æŒ‰ **åˆ›å»º**æµç¨‹é‡å»ºï¼›
3. ï¼ˆå¯é€‰ï¼‰æä¾›å•äº‹åŠ¡â€œç§»åŠ¨é¢„çº¦â€æ¥å£ï¼Œéœ€è¦æ›´å¤æ‚çš„åŒºé—´é”ä¸å†²çªå¤„ç†ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API
participant D as DB
U->>W: é€‰æ‹©æ–°çš„æ§½ä½
W->>A: PATCH /api/appointments/{id} {action: cancel}
A->>D: å–æ¶ˆæ—§é¢„çº¦ (æ ¡éªŒæ—¶é—´çª—å£)
W->>A: POST /api/appointments {newSlot,...}
A->>D: èµ°åˆ›å»ºæµç¨‹(ç§‘ç›®/æœåŠ¡çº§åˆ«/å¹‚ç­‰/å†²çª)
A-->>W: è¿”å›æ–°é¢„çº¦
```

## 3.6 å­¦ç”Ÿï½œæŸ¥çœ‹æˆ‘çš„é¢„çº¦

**ç›®æ ‡**ï¼šæŒ‰çŠ¶æ€/æ—¶é—´èŒƒå›´åˆ†é¡µæŸ¥è¯¢ï¼Œé»˜è®¤æŒ‰æ—¶é—´å‡åºã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒèº«ä»½ï¼›
2. ç»„åˆ where æ¡ä»¶ä¸æ—¶é—´èŒƒå›´ï¼›
3. æ¸¸æ ‡åˆ†é¡µè¿”å›åˆ—è¡¨ä¸ä¸‹ä¸€é¡µæ¸¸æ ‡ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API
participant D as DB
U->>W: é€‰æ‹©ç­›é€‰æ¡ä»¶
W->>A: GET /api/appointments?role=student&status&from&to
A->>D: æŸ¥è¯¢å¹¶æŒ‰ scheduledTime å‡åº/æ¸¸æ ‡åˆ†é¡µ
D-->>A: items[]
A-->>W: items[] + nextCursor
```

## 3.7 æ•™å¸ˆï½œç»´æŠ¤æ¯å‘¨å¯ç”¨æ€§

**ç›®æ ‡**ï¼šè®¾ç½®/æ›´æ–° `dayOfWeek + start/end`ï¼ŒåŒä¸€å¤©å¯å¤šä¸ªåŒºé—´ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒæ•™å¸ˆèº«ä»½ä¸å­—æ®µåˆæ³•æ€§ï¼›
2. æ–°å¢æˆ–è¦†ç›–åŒºé—´ï¼ˆé¿å…äº¤å‰é‡å çš„å¯é€‰æ ¡éªŒï¼‰ï¼›
3. å¤±æ•ˆæœªæ¥è‹¥å¹²å¤©çš„ `slots` ç¼“å­˜é”®ï¼ˆæˆ–æ ‡è®°ä¸ºè„ï¼‰ã€‚

```mermaid
sequenceDiagram
participant T as Teacher
participant W as Web
participant A as API (Availability)
participant D as DB
participant C as Cache
T->>W: å½•å…¥/ç¼–è¾‘åŒºé—´
W->>A: POST /api/teachers/{id}/availability
A->>D: å†™å…¥æˆ–æ›´æ–° availability
A->>C: å¤±æ•ˆ slots ç¼“å­˜ (å—å½±å“æ—¥æœŸèŒƒå›´)
A-->>W: 200 OK
```

## 3.8 æ•™å¸ˆï½œç»´æŠ¤é˜»å¡æ—¶é—´

**ç›®æ ‡**ï¼šè®°å½•ä¸€æ®µä¸å¯é¢„çº¦æ—¶é—´ï¼ˆä¸Šè¯¾/å¼€ä¼š/ä¼‘å‡ç­‰ï¼‰ã€‚

**å…³é”®è§„åˆ™**ï¼šä¸é¢„çº¦å†²çªæ—¶æç¤ºé£é™©ï¼ˆéœ€äººå·¥æ²Ÿé€šï¼‰ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒæ—¶é—´èŒƒå›´ä¸æœ€å°ç²’åº¦ï¼›
2. å†™å…¥ `blocked_times`ï¼›
3. è‹¥ä¸æ—¢æœ‰é¢„çº¦é‡å ï¼Œè¿”å›å‘Šè­¦å­—æ®µä¾›å‰ç«¯æç¤ºï¼›
4. å¤±æ•ˆç›¸å…³æ—¥æœŸçš„æ§½ä½ç¼“å­˜ã€‚

```mermaid
sequenceDiagram
participant T as Teacher
participant W as Web
participant A as API (Blocked)
participant D as DB
participant C as Cache
T->>W: é€‰æ‹©èµ·æ­¢æ—¶é—´ä¸åŸå› 
W->>A: POST /api/blocked-times
A->>D: å†™å…¥ blocked_times
A->>C: å¤±æ•ˆ slots ç¼“å­˜
A-->>W: 200 OK (å¦‚ä¸æ—¢æœ‰é¢„çº¦é‡å â†’å‰ç«¯æç¤ºé£é™©)
```

## 3.9 æ•™å¸ˆï½œå®¡æ‰¹/æ‹’ç»é¢„çº¦

**ç›®æ ‡**ï¼šå¯¹ `pending` æ‰§è¡Œ `approve|cancel`ã€‚

**å…³é”®è§„åˆ™**ï¼šè®°å½•åŸå› /æ—¶é—´ï¼›é€šçŸ¥ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒæ“ä½œè€…ä¸ºè¯¥æ•™å¸ˆï¼›
2. è‹¥çŠ¶æ€é `pending` â†’ `STATE_CONFLICT`ï¼›
3. æŒ‰åŠ¨ä½œæ›´æ–°çŠ¶æ€å¹¶è®°å½•å®¡è®¡ï¼›
4. å‘é€ç»“æœé€šçŸ¥ã€‚

```mermaid
sequenceDiagram
participant T as Teacher
participant W as Web
participant A as API (Appointments)
participant D as DB
participant E as Email
T->>W: åœ¨å¾…åŠç‚¹å‡» é€šè¿‡/æ‹’ç»
W->>A: PATCH /api/appointments/{id} {action}
A->>D: æ ¡éªŒå½“å‰çŠ¶æ€= pending & èµ„æºå½’å±
alt é€šè¿‡
A->>D: æ›´æ–°ä¸º approved, å†™ approvedAt
else æ‹’ç»
A->>D: æ›´æ–°ä¸º cancelled, å†™ reason
end
A->>E: é€šçŸ¥å­¦ç”Ÿ
A-->>W: 200 OK
```

## 3.10 ç®¡ç†ï½œæœåŠ¡çº§åˆ«ç­–ç•¥

**ç›®æ ‡**ï¼šå‚æ•°åŒ–é…é¢é˜ˆå€¼ã€è¶…æ—¶é˜ˆå€¼ã€æé†’ç­–ç•¥ç­‰ï¼ˆä¸ºåç»­ç­–ç•¥è¡¨åšå‡†å¤‡ï¼‰ã€‚

**æ­¥éª¤**ï¼š

1. å®šä¹‰ç­–ç•¥è¡¨ï¼ˆå¯å«ç§Ÿæˆ·ç»´åº¦ï¼‰ï¼›
2. ä¸šåŠ¡è¯»å–ç­–ç•¥æ—¶åŠ å…¥ç¼“å­˜ï¼›
3. æ›´æ–°ç­–ç•¥æ—¶å¹¿æ’­/åˆ·æ–°ç›¸å…³ç¼“å­˜é”®ã€‚

```mermaid
sequenceDiagram
participant M as Admin
participant W as Web(Admin)
participant A as API (Policy)
participant D as DB
M->>W: ä¿®æ”¹ç­–ç•¥å‚æ•°
W->>A: PUT /api/policies {quota,expireHours,remindOffsets}
A->>D: Upsert ç­–ç•¥è¡¨
A-->>W: 200 OK
```

## 3.11 ç³»ç»Ÿï½œ48h å¾…å®¡æ‰¹è¿‡æœŸ

**ç›®æ ‡**ï¼šå®šæ—¶æ‰«æ `pending` è¶…æ—¶â†’`expired` å¹¶é€šçŸ¥ã€‚

**æ­¥éª¤**ï¼š

1. Cron å®šæ—¶è§¦å‘ï¼›
2. åˆ†é¡µæ‰¹å¤„ç†ï¼Œé¿å…å¤§äº‹åŠ¡ï¼›
3. è®°å½•å®¡è®¡ä¸å¤±è´¥é‡è¯•ç»Ÿè®¡ï¼›
4. å¯é€‰ï¼šå°†é€šçŸ¥æ¨å…¥é˜Ÿåˆ—å¼‚æ­¥å‘é€ã€‚

```mermaid
sequenceDiagram
participant Q as Cron
participant A as Job API
participant D as DB
participant E as Email
Q->>A: POST /api/jobs/expire-pending
A->>D: æŸ¥ pending where createdAt < now-48h
A->>D: æ‰¹é‡æ›´æ–°ä¸º expired
A->>E: å‘é€è¿‡æœŸé€šçŸ¥ï¼ˆå­¦ç”Ÿ+æ•™å¸ˆï¼‰
```

## 3.12 ç³»ç»Ÿï½œæœˆåˆé…é¢é‡ç½®

**ç›®æ ‡**ï¼šæ¯æœˆ 1 æ—¥é‡ç½® Level1/2 é…é¢è®¡æ•°å¹¶æ›´æ–°æ—¶é—´æˆ³ã€‚

**æ­¥éª¤**ï¼š

1. çº¦å®šè§¦å‘æ—¶é—´ï¼ˆç³»ç»Ÿæ—¶åŒº/æ•™å¸ˆæ—¶åŒºï¼Œæ‹©ä¸€å¹¶åœ¨ UI æ˜ç¤ºï¼‰ï¼›
2. æ”¯æŒå¹‚ç­‰å¤šæ¬¡æ‰§è¡Œï¼›
3. è®°å½•æ‰§è¡Œæ—¥å¿—ä¸æŒ‡æ ‡ã€‚

```mermaid
sequenceDiagram
participant Q as Cron
participant A as Job API
participant D as DB
Q->>A: POST /api/jobs/reset-quota (æ¯æœˆ1æ—¥ 00:05)
A->>D: UPDATE students SET monthlyMeetingsUsed=0, lastQuotaReset=NOW()
D-->>A: è¿”å›å½±å“è¡Œæ•°
```

## 3.13 ç³»ç»Ÿï½œæé†’é€šçŸ¥

**ç›®æ ‡**ï¼šT-24h / T-1h æé†’å­¦ç”Ÿä¸æ•™å¸ˆã€‚

**æ­¥éª¤**ï¼š

1. è®¡ç®—æ—¶é—´çª—å£ï¼ˆUTCï¼‰ï¼›
2. é˜²é‡ï¼šå¯¹åŒä¸€é¢„çº¦åŒä¸€æé†’ç±»å‹è®¾ç½®æŒ‡çº¹å»é‡ï¼›
3. å¤±è´¥é‡è¯•ä¸é€€é¿

```mermaid
sequenceDiagram
participant Q as Cron/Queue
participant A as Job API
participant D as DB
participant E as Email
Q->>A: è§¦å‘ remind-24h / remind-1h
A->>D: æŸ¥ approved ä¸” scheduledTime in çª—å£
A->>E: æ‰¹é‡å‘é€æé†’ï¼ˆå«å–æ¶ˆé“¾æ¥ï¼‰
```

## 3.14 ç³»ç»Ÿï½œå€™è¡¥é˜Ÿåˆ—

**ç›®æ ‡**ï¼šçƒ­é—¨æ—¶æ®µè¢«å æ—¶å¯åŠ å…¥å€™è¡¥ï¼Œé‡Šæ”¾æ—¶è‡ªåŠ¨é¡¶æ›¿ã€‚

**æ­¥éª¤**ï¼š

1. å€™è¡¥è¡¨ç»“æ„ï¼š`teacherId,date,slot,studentId,priority,status,createdAt`ï¼›
2. æ§½ä½é‡Šæ”¾è§¦å‘å™¨ï¼šå–æ¶ˆ/æ‹’ç»/è¿‡æœŸäº‹ä»¶ç›‘å¬ï¼›
3. é€‰å–è§„åˆ™ï¼šæŒ‰ä¼˜å…ˆçº§+æ—¶é—´å…ˆåï¼›
4. åˆ›å»ºé¢„çº¦ä¸é€šçŸ¥ï¼ˆå¯è®¾ç½®â€œä¿ç•™æ—¶é•¿â€ï¼Œé€¾æœŸè‡ªåŠ¨å›æ”¶ç»™ä¸‹ä¸€ä½ï¼‰ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API (Waitlist)
participant D as DB
participant E as Email
U->>W: åœ¨å·²æ»¡æ§½ä½ç‚¹å‡»åŠ å…¥å€™è¡¥
W->>A: POST /api/waitlist {teacherId,date,slot,studentId}
A->>D: å†™å…¥å€™è¡¥é˜Ÿåˆ— (ä¼˜å…ˆçº§: Premium > Level1 > Level2)
Note over A,D: ç›‘å¬å–æ¶ˆ/æ‹’ç»äº‹ä»¶
A->>D: å½“æ§½ä½é‡Šæ”¾â†’é€‰æ‹©å€™è¡¥äººé€‰å¹¶åˆ›å»ºé¢„çº¦(approved/pending)
A->>E: é€šçŸ¥å€™è¡¥æˆåŠŸ/ä¿ç•™æ—¶é•¿
```

# å››ã€æ•°æ®åº“è®¾è®¡

## 4.1 usersï¼ˆç»Ÿä¸€èº«ä»½è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
| --- | --- | --- | --- |
| id | UUID | PK | ç»Ÿä¸€ç”¨æˆ· ID |
| email | VARCHAR(255) | UNIQUE, NOT NULL | ç™»å½•é‚®ç®± |
| password_hash | VARCHAR(255) | NOT NULL | å¯†ç å“ˆå¸Œï¼ˆArgon2id / bcryptâ‰¥10ï¼‰ |
| role | ENUM('student','teacher','admin') | NOT NULL | é»˜è®¤è§’è‰²ï¼ˆç™»å½•åæˆæƒç”¨ï¼‰ |
| status | ENUM('pending','active','frozen') | NOT NULL DEFAULT 'pending' | è´¦æˆ·çŠ¶æ€ |
| last_login_at | TIMESTAMPTZ |  | æœ€è¿‘ç™»å½•æ—¶é—´ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() |  |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() |  |
|  |  |  |  |

## 4.2 studentsï¼ˆå­¦ç”Ÿæ‰©å±•è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
| --- | --- | --- | --- |
| id | UUID | PK |  |
| user_id | UUID | FK â†’ users(id), UNIQUE, NOT NULL | ä¸ users 1:1 ç»‘å®š |
| service_level | ENUM('level1','level2','premium') | NOT NULL | æœåŠ¡çº§åˆ« |
| monthly_meetings_used | INT | DEFAULT 0 | å½“æœˆå·²ç”¨é…é¢ |
| last_quota_reset | DATE | DEFAULT CURRENT_DATE | ä¸Šæ¬¡é…é¢é‡ç½®æ—¥æœŸ |
| enrolled_subjects | TEXT[] |  | å·²é€‰ç§‘ç›® |
| grade_level | INT |  | å¹´çº§ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() |  |

## 4.3 teachersï¼ˆæ•™å¸ˆè¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
| --- | --- | --- | --- |
| id | UUID | PK |  |
| user_id | UUID | FK â†’ users(id), UNIQUE, NOT NULL | ä¸ users 1:1 ç»‘å®š |
| subjects | TEXT[] |  | æˆè¯¾ç§‘ç›®ï¼ˆæœªæ¥å¯æ‹†ä¸ºå­—å…¸è¡¨+å…³è”è¡¨ï¼‰ |
| max_daily_meetings | INT | DEFAULT 6 | æ¯æ—¥ä¸Šé™ |
| buffer_minutes | INT | DEFAULT 15 | ä¼šè®®ç¼“å†²åˆ†é’Ÿ |
| timezone | VARCHAR(64) | NOT NULL DEFAULT 'Asia/Shanghai' | æ•™å¸ˆæ‰€åœ¨æ—¶åŒº |
| created_at | TIMESTAMPTZ | DEFAULT NOW() |  |

## 4.4 adminsï¼ˆç®¡ç†å‘˜è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
| --- | --- | --- | --- |
| id | UUID | PK |  |
| user_id | UUID | FK â†’ users(id), UNIQUE, NOT NULL | ä¸ users 1:1 ç»‘å®š |
| scope | JSONB |  | ç®¡ç†èŒƒå›´ï¼ˆå­¦é™¢/é™¢ç³»/å¹´çº§ï¼‰ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() |  |

## 4.5 teacher_availabilityï¼ˆæ•™å¸ˆå¯ç”¨æ€§ï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
| --- | --- | --- | --- |
| id | UUID | PK |  |
| teacher_id | UUID | FK â†’ teachers(id), NOT NULL | æ•™å¸ˆ |
| day_of_week | INT | 0â€“6 | å‘¨æ—¥=0 |
| start_time | TIME | NOT NULL |  |
| end_time | TIME | NOT NULL |  |
| is_recurring | BOOLEAN | DEFAULT true | æ˜¯å¦æ¯å‘¨é‡å¤ |

## 4.6 blocked_timesï¼ˆé˜»å¡æ—¶æ®µï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
| --- | --- | --- | --- |
| id | UUID | PK |  |
| teacher_id | UUID | FK â†’ teachers(id) | æ•™å¸ˆ |
| start_time | TIMESTAMPTZ | NOT NULL |  |
| end_time | TIMESTAMPTZ | NOT NULL |  |
| reason | VARCHAR(255) |  | åŸå›  |
| created_at | TIMESTAMPTZ | DEFAULT NOW() |  |

## 4.7 appointmentsï¼ˆé¢„çº¦è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
| --- | --- | --- | --- |
| id | UUID | PK |  |
| student_id | UUID | FK â†’ students(id) | å­¦ç”Ÿ |
| teacher_id | UUID | FK â†’ teachers(id) | æ•™å¸ˆ |
| subject | VARCHAR(100) | NOT NULL | ç§‘ç›® |
| scheduled_time | TIMESTAMPTZ | NOT NULL | å¼€å§‹æ—¶é—´ï¼ˆUTCï¼‰ |
| duration_minutes | INT | DEFAULT 30 | æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ |
| status | ENUM('pending','approved','completed','cancelled','no_show','expired') | NOT NULL | ç»Ÿä¸€çŠ¶æ€æšä¸¾ |
| approval_required | BOOLEAN | NOT NULL | æ˜¯å¦éœ€å®¡æ‰¹ |
| approved_at | TIMESTAMPTZ |  | å®¡æ‰¹æ—¶é—´ |
| idempotency_key | VARCHAR(128) | UNIQUE | å¹‚ç­‰é”® |
| created_at | TIMESTAMPTZ | DEFAULT NOW() |  |
| time_range | TSTZRANGE | ç”Ÿæˆåˆ—ï¼š`tstzrange(scheduled_time, scheduled_time + duration_minutes * interval '1 minute')` |  |
| çº¦æŸ | EXCLUDE USING GIST (teacher_id WITH =, time_range WITH &&) | é˜²æ­¢æ—¶é—´é‡å  |  |

## 4.8  æœåŠ¡çº§åˆ«ç­–ç•¥è¡¨ï¼ˆservice_policiesï¼‰

| å­—æ®µå | ç±»å‹ | æè¿° |
| --- | --- | --- |
| policy_id | UUID | ç­–ç•¥ ID |
| level | Enum | æœåŠ¡çº§åˆ« |
| max_daily | Int | æ¯æ—¥æœ€å¤§é¢„çº¦æ•°ï¼ˆå½“ `teacher.max_daily_meetings` å­˜åœ¨æ—¶**ä¼˜å…ˆç”Ÿæ•ˆ**ï¼‰ |
| expire_hours | Int | å¾…å®¡æ‰¹è¿‡æœŸæ—¶é•¿ï¼ˆå°æ—¶ï¼‰ |
| reminder | Boolean | æ˜¯å¦å¼€å¯æé†’ |

## 4.9 å®¡è®¡æ—¥å¿—è¡¨ï¼ˆaudit_logsï¼‰

| å­—æ®µå | ç±»å‹ | æè¿° |
| --- | --- | --- |
| log_id | UUID | æ—¥å¿— ID |
| actor_id | UUID | æ“ä½œè€… ID |
| action | String | åŠ¨ä½œåç§° |
| target_id | UUID | ç›®æ ‡å¯¹è±¡ ID |
| created_at | DateTime | æ“ä½œæ—¶é—´ |

# äº”ã€æ¥å£è®¾è®¡

## 5.1  å­¦ç”Ÿç«¯æ¥å£ï¼ˆStudent APIsï¼‰

> é‰´æƒï¼šBearer JWTï¼ˆrole=studentï¼‰ã€‚æ—¶åŒºï¼šæ‰€æœ‰æ—¶é—´å­—æ®µå‡ä¸º ISO8601 UTCã€‚
> 

### 5.1.1 æŸ¥è¯¢æ•™å¸ˆå¯ç”¨æ§½ä½

- **GET** `/api/slots?teacherId={id}&date=YYYY-MM-DD&duration=30`
- **è¯´æ˜**ï¼š`date` å‚æ•°**æŒ‰æ•™å¸ˆæ—¶åŒº**è§£é‡Šï¼Œåç«¯æ¢ç®—ä¸º UTC å­˜å‚¨ä¸è®¡ç®—ã€‚
- **è¯·æ±‚å‚æ•°**ï¼š
    - `teacherId` *(required)*ï¼šæ•™å¸ˆ ID
    - `date` *(required)*ï¼šæ—¥æœŸ
    - `duration` *(optional, default=30)*ï¼šä¼šè®®æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
- **å“åº” 200**ï¼š

```json
{
  "teacherId": "t_123",
  "date": "2025-08-22",
  "duration": 30,
  "slots": ["2025-08-22T01:00:00Z", "2025-08-22T01:30:00Z"]
}
```

- **é”™è¯¯**ï¼š`BAD_REQUEST`ã€`TEACHER_NOT_FOUND`ã€‚

### 5.1.2 åˆ›å»ºé¢„çº¦

- **POST** `/api/appointments`
- **è¯´æ˜**ï¼šæ ¹æ®æœåŠ¡çº§åˆ«è‡ªåŠ¨è·¯ç”±åˆ° `approved`/`pending`ï¼Œå¸¦å¹‚ç­‰é”®ã€‚
- **è¯·æ±‚ä½“**ï¼š

```json
{
  "studentId": "s_123",
  "teacherId": "t_123",
  "subject": "math",
  "scheduledTime": "2025-08-22T01:00:00Z",
  "durationMinutes": 30,
  "idempotencyKey": "s_123-t_123-2025-08-22T01:00:00Z"
}
```

- **å“åº” 201**ï¼š

```json
{ 
"id": "a_456", 
"status": "approved", 
"approvalRequired": false 
}
```

- **é”™è¯¯**ï¼š`SUBJECT_MISMATCH`ã€`SLOT_TAKEN`ã€`QUOTA_EXCEEDED`ã€`MAX_DAILY_REACHED`ã€`IDEMPOTENT_CONFLICT`ã€`BAD_REQUEST`ã€‚

### 5.1.3 å–æ¶ˆé¢„çº¦

- **PATCH** `/api/appointments/{id}`
- **è¯·æ±‚ä½“**ï¼š`{ "action": "cancel", "reason": "è®¡åˆ’å†²çª" }`
- **å“åº” 200**ï¼š`{ "ok": true }`
- **é”™è¯¯**ï¼š`STATE_CONFLICT`ï¼ˆå¦‚å·² completed/expiredï¼‰ã€`FORBIDDEN`ï¼ˆè¶Šæƒï¼‰ã€‚

### 5.1.4 æˆ‘çš„é¢„çº¦åˆ—è¡¨

- **GET** `/api/appointments?role=student&studentId={id}&status={pending|approved|...}&from=&to=&cursor=&limit=`
- **å“åº” 200**ï¼š

```json
{ 
"items": 
[
	{
		"id":"a_1",
		"scheduledTime":"...",
		"status":"approved"
		}
	], 
"nextCursor": "eyJpZCI6..." 
}
```

### 5.1.5 æ”¹æœŸï¼ˆé»˜è®¤ï¼šå–æ¶ˆ+æ–°å»ºï¼‰

- å…ˆè°ƒç”¨ **5.1.3** å–æ¶ˆï¼Œå†è°ƒç”¨ **5.1.2** åˆ›å»ºæ–°é¢„çº¦ï¼›
- ï¼ˆå¯é€‰ï¼‰å°†æ¥æä¾› `/api/appointments/{id}/reschedule` ä¸€æ­¥åˆ°ä½æ¥å£ã€‚

---

## 5.2 æ•™å¸ˆç«¯æ¥å£ï¼ˆTeacher APIsï¼‰

> é‰´æƒï¼šBearer JWTï¼ˆrole=teacherï¼‰ã€‚ä»…èƒ½æ“ä½œè‡ªå·±çš„èµ„æºã€‚
> 

### 5.2.1 ç»´æŠ¤æ¯å‘¨å¯ç”¨æ€§

- **GET** `/api/teachers/{id}/availability`
- **POST** `/api/teachers/{id}/availability`
- **POST è¯·æ±‚ä½“**ï¼š

```json
{ 
"dayOfWeek": 1,
 "startTime": "09:00", 
 "endTime": "12:00", 
 "isRecurring": true 
 }
```

- **å“åº” 200**ï¼š`{ "ok": true }`

### 5.2.2 ç»´æŠ¤é˜»å¡æ—¶é—´

- **POST** `/api/blocked-times`
- **è¯·æ±‚ä½“**ï¼š

```json
{
 "teacherId": "t_123", 
 "startTime": "2025-08-22T02:00:00Z", 
 "endTime": "2025-08-22T04:00:00Z", 
 "reason": "Dept meeting" 
 }
```

- **å“åº” 200**ï¼š`{ "ok": true }`

### 5.2.3 å®¡æ‰¹/æ‹’ç»é¢„çº¦

- **PATCH** `/api/appointments/{id}`
- **è¯·æ±‚ä½“**ï¼š`{ "action": "approve" }` æˆ– `{ "action": "cancel", "reason": "ä¸åˆé€‚" }`
- **å“åº” 200**ï¼š`{ "ok": true }`
- **é”™è¯¯**ï¼š`STATE_CONFLICT`ï¼ˆå½“å‰ä¸æ˜¯ pendingï¼‰ã€‚

### 5.2.4 æ•™å¸ˆè§†è§’é¢„çº¦åˆ—è¡¨

- **GET** `/api/appointments?role=teacher&teacherId={id}&status=&from=&to=&cursor=&limit=`

---

## 5.3 ç³»ç»Ÿä¸ç®¡ç†æ¥å£ï¼ˆSystem & Admin APIsï¼‰

> é‰´æƒï¼šBearer JWTï¼ˆrole=admin æˆ–åå°ä»»åŠ¡ä»¤ç‰Œï¼‰ã€‚
> 

### 5.3.1 æœåŠ¡çº§åˆ«ç­–ç•¥ï¼ˆå¯é€‰ï¼‰

- **PUT** `/api/policies`
- **è¯·æ±‚ä½“**ï¼š

```json
{
    "level1": {
        "monthlyAutoApprove": 2
    },
    "level2": {
        "monthlyAutoApprove": 0
    },
    "premium": {
        "priority": true
    },
    "expireHours": 48,
    "remindOffsets": [
        24,
        1
    ]
}
```

- **å“åº” 200**ï¼š`{ "ok": true }`

### 5.3.2 48 å°æ—¶å¾…å®¡æ‰¹è¿‡æœŸ Job

- **POST** `/api/jobs/expire-pending`
- **å“åº” 200**ï¼š`{ "updated": 12 }`

### 5.3.3 æœˆåˆé…é¢é‡ç½® Job

- **POST** `/api/jobs/reset-quota`
- **å“åº” 200**ï¼š`{ "updated": 245 }`

### 5.3.4 å¥åº·æ£€æŸ¥

- **GET** `/api/healthz` â†’ `200`

```json
{
    "ok": true,
    "time": "..."
}
```

### 5.3.5 å€™è¡¥é˜Ÿåˆ—

- **POST** `/api/waitlist`
    
    è¯·æ±‚ä½“ï¼š
    
    ```json
    {
        "teacherId": "t_1",
        "date": "2025-08-22",
        "slot": "2025-08-22T01:00:00Z",
        "studentId": "s_1"
    }
    ```
    
- **POST** `/api/waitlist/promote` ï¼ˆç³»ç»Ÿå†…éƒ¨ï¼Œå½“æ§½ä½é‡Šæ”¾æ—¶è§¦å‘ï¼‰

# å…­ã€ç³»ç»Ÿå®‰å…¨

- **è®¤è¯ä¸ä¼šè¯**
    - Access Token (JWT, 15m) + Refresh Token (30d, å¯è½®æ¢)ï¼Œå­˜æ”¾ HttpOnly+Secure Cookieã€‚
    - ä¿®æ”¹å¯†ç /é‡ç½®å¯†ç æ—¶åŠé”€å…¨éƒ¨ Refreshã€‚
- **å¯†ç ç­–ç•¥**
    - æœ€å°‘ 8 ä½ï¼Œå«å­—æ¯ä¸æ•°å­—ã€‚
- **é˜²æš´åŠ›ä¸é™æµ**
    - ç™»å½•ä¸é‡ç½®æ¥å£ï¼šRedis æ»‘åŠ¨çª—å£é™é€Ÿï¼Œå¤±è´¥ N æ¬¡é”å®šè´¦æˆ·ã€‚
- **é‚®ä»¶å®‰å…¨**
    - æ‰€æœ‰é‚®ä»¶ Token ä»…ä¿å­˜å“ˆå¸Œï¼Œå•æ¬¡ä½¿ç”¨ï¼ŒçŸ­æœŸæœ‰æ•ˆã€‚
- **å®¡è®¡ä¸RBAC**
    - æ‰€æœ‰æ•æ„Ÿæ“ä½œå†™ `audit_logs`ã€‚
    - ä¸¥æ ¼åŸºäº `role + scope` åš API æƒé™æ ¡éªŒã€‚

---

# ä¸ƒã€æœ¬åœ°å¼€å‘ä¸éƒ¨ç½²

## 7.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ

### å¿«é€Ÿå¼€å§‹
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/bigkrys/EducationalMeetingSchedulingSystem.git
cd EducationalMeetingSchedulingSystem

# ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è®¾ç½®ï¼ˆæ¨èï¼‰
./scripts/setup-local.sh        # macOS/Linux
scripts\setup-local.bat         # Windows

# æˆ–æ‰‹åŠ¨è®¾ç½®
pnpm install
cp env.local.example .env.local
node scripts/generate-secrets.js
pnpm db:generate
pnpm db:push
pnpm db:seed
pnpm dev
```

### ç¯å¢ƒè¦æ±‚
- **Node.js**: 18.x+
- **pnpm**: 8.x+
- **æ•°æ®åº“**: SQLite (å¼€å‘) æˆ– PostgreSQL (ç”Ÿäº§)

### è¯¦ç»†æ–‡æ¡£
- ğŸ“š [æœ¬åœ°å¼€å‘æŒ‡å—](LOCAL_DEVELOPMENT.md) - å®Œæ•´çš„æœ¬åœ°ç¯å¢ƒæ­å»ºæ•™ç¨‹
- ğŸ”‘ [å¯†é’¥ç”Ÿæˆè„šæœ¬](scripts/generate-secrets.js) - è‡ªåŠ¨ç”Ÿæˆå®‰å…¨å¯†é’¥
- ğŸš€ [éƒ¨ç½²æŒ‡å—](DEPLOYMENT.md) - Verceléƒ¨ç½²è¯¦ç»†æ­¥éª¤

## 7.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### Verceléƒ¨ç½²ï¼ˆæ¨èï¼‰
```bash
# å®‰è£…Vercel CLI
npm i -g vercel

# éƒ¨ç½²
vercel --prod
```

### ç¯å¢ƒå˜é‡é…ç½®
```bash
# å¿…éœ€ç¯å¢ƒå˜é‡
DATABASE_URL="postgresql://username:password@host:port/database"
JWT_SECRET="your-super-secret-jwt-key-here-32-chars-min"
JWT_REFRESH_SECRET="your-super-secret-refresh-key-here-32-chars-min"
NEXTAUTH_SECRET="your-nextauth-secret-here-32-chars-min"
NEXTAUTH_URL="https://your-project.vercel.app"
NODE_ENV="production"
NEXT_PUBLIC_APP_URL="https://your-project.vercel.app"
```

### æ•°æ®åº“æ¨è
- **å¼€å‘**: SQLite (æœ¬åœ°æ–‡ä»¶)
- **ç”Ÿäº§**: Supabase æˆ– Neon (PostgreSQL)

## 7.3 é¡¹ç›®ç»“æ„
```
edu-scheduler/
â”œâ”€â”€ src/                    # æºä»£ç 
â”‚   â”œâ”€â”€ app/               # Next.js App Router
â”‚   â”œâ”€â”€ components/        # Reactç»„ä»¶
â”‚   â”œâ”€â”€ lib/              # å·¥å…·åº“
â”‚   â””â”€â”€ types/            # TypeScriptç±»å‹
â”œâ”€â”€ prisma/               # æ•°æ®åº“é…ç½®
â”œâ”€â”€ scripts/              # å·¥å…·è„šæœ¬
â”œâ”€â”€ docs/                 # æ–‡æ¡£
â”œâ”€â”€ LOCAL_DEVELOPMENT.md  # æœ¬åœ°å¼€å‘æŒ‡å—
â”œâ”€â”€ DEPLOYMENT.md         # éƒ¨ç½²æŒ‡å—
â””â”€â”€ README.md             # é¡¹ç›®è¯´æ˜
```

---

# å…«ã€è´¡çŒ®æŒ‡å—

## 8.1 å¼€å‘æµç¨‹
1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

## 8.2 ä»£ç è§„èŒƒ
- ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
- éµå¾ª ESLint è§„åˆ™
- ç¼–å†™æ¸…æ™°çš„æ³¨é‡Šå’Œæ–‡æ¡£
- æ·»åŠ é€‚å½“çš„æµ‹è¯•ç”¨ä¾‹

## 8.3 é—®é¢˜åé¦ˆ
- ä½¿ç”¨ [GitHub Issues](https://github.com/bigkrys/EducationalMeetingSchedulingSystem/issues) æŠ¥å‘Šé—®é¢˜
- æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå¤ç°æ­¥éª¤
- æ ‡æ³¨é—®é¢˜ç±»å‹ï¼ˆbug/feature/enhancementï¼‰

---

# ä¹ã€è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

---

# åã€è”ç³»æ–¹å¼

- **é¡¹ç›®åœ°å€**: [https://github.com/bigkrys/EducationalMeetingSchedulingSystem](https://github.com/bigkrys/EducationalMeetingSchedulingSystem)
- **åœ¨çº¿æ¼”ç¤º**: [https://EducationalMeetingSchedulingSystem-git-develop-bigkrys.vercel.app](https://EducationalMeetingSchedulingSystem-git-develop-bigkrys.vercel.app)
- **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/bigkrys/EducationalMeetingSchedulingSystem/issues)

---

# åä¸€ã€å½“å‰å·²å®ç°åŠŸèƒ½å¦‚ä¸‹


âœ… å­¦ç”Ÿç™»å½•ï¼ˆJWT æ¨¡æ‹Ÿï¼‰

âœ… æŸ¥çœ‹å¯ç”¨æ—¶æ®µï¼ˆåŸºäºæ•™å¸ˆå¯ç”¨æ€§ã€ç¼“å†²æ—¶é—´ã€å†²çªæ£€æµ‹ï¼‰

âœ… åˆ›å»ºé¢„çº¦ï¼š

Level1 å­¦ç”Ÿå‰ 2 æ¬¡è‡ªåŠ¨æ‰¹å‡†ï¼Œä¹‹å pending

Level2 å­¦ç”Ÿå…¨éƒ¨ pending

Premium å­¦ç”Ÿå…¨éƒ¨è‡ªåŠ¨æ‰¹å‡†

âœ… ç§‘ç›®é™åˆ¶æ ¡éªŒï¼ˆåªèƒ½é¢„çº¦è‡ªå·±æ³¨å†Œç§‘ç›®çš„æ•™å¸ˆï¼‰

âœ… æœˆåº¦é…é¢æ£€æŸ¥ä¸è‡ªåŠ¨é‡ç½®ï¼ˆæ‡’è§¦å‘é€»è¾‘ï¼‰

âœ… æˆ‘çš„é¢„çº¦åˆ—è¡¨ï¼ˆçŠ¶æ€ï¼špending / approved / expired / cancelledï¼‰

2. æ•™å¸ˆç«¯

âœ… æ•™å¸ˆç™»å½•ï¼ˆJWT æ¨¡æ‹Ÿï¼‰

âœ… ç®¡ç†æ¯å‘¨å¯ç”¨æ—¶é—´çª—å£

âœ… æ–°å¢/ç®¡ç†ä¸å¯ç”¨æ—¶é—´ï¼ˆblocked timesï¼‰

âœ… å®¡æ‰¹é¢„çº¦ï¼ˆpending â†’ approved / rejectedï¼‰

âœ… å¹¶å‘æ§åˆ¶ï¼ˆç®€å•ç‰ˆæœ¬ï¼Œé¿å…é‡å¤å®¡æ‰¹ï¼‰

âœ… æŸ¥çœ‹æ—¥ç¨‹åˆ—è¡¨ï¼ˆå·²æ‰¹å‡† / å·²è¿‡æœŸç­‰ï¼‰

3. ç³»ç»Ÿé€»è¾‘

âœ… è‡ªåŠ¨å†²çªæ£€æµ‹ï¼ˆé¢„çº¦æ—¶é—´ + ç¼“å†²åŒº vs å·²æœ‰é¢„çº¦/blockedï¼‰

âœ… çŠ¶æ€æœºï¼špending â†’ approved / cancelled / expired

âœ… 48h è¶…æ—¶å¤„ç†ï¼ˆæ‰¹å¤„ç†æ‰«æ â†’ è‡ªåŠ¨æ ‡è®° expiredï¼‰

âœ… æœˆåˆé…é¢é‡ç½®ï¼ˆæ‰¹å¤„ç†é€»è¾‘ï¼‰

âœ… å¹‚ç­‰æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤æäº¤åŒä¸€é¢„çº¦ï¼‰

4. é€šçŸ¥ä¸æ—¥å¿—

âœ… é‚®ä»¶é€šçŸ¥ï¼š

é¢„çº¦æˆåŠŸï¼ˆå­¦ç”Ÿ + æ•™å¸ˆï¼‰

å®¡æ‰¹é€šè¿‡/æ‹’ç»ï¼ˆé€šçŸ¥å­¦ç”Ÿï¼‰

48h è¶…æ—¶ï¼ˆé€šçŸ¥åŒæ–¹ï¼‰



# åäºŒã€ å…³é”®ç®—æ³•å®ç°

## 12.1 ç”Ÿæˆå¯ç”¨æ—¶é—´æ®µç®—æ³•

### æ ¸å¿ƒç®—æ³•ï¼š`calculateAvailableSlots()`

**åŠŸèƒ½æè¿°**ï¼šæ ¹æ®æ•™å¸ˆçš„å¯ç”¨æ€§è®¾ç½®ã€é˜»å¡æ—¶é—´å’Œå·²æœ‰é¢„çº¦ï¼Œç”ŸæˆæŒ‡å®šæ—¥æœŸçš„å¯ç”¨æ—¶é—´æ®µåˆ—è¡¨ã€‚

**ç®—æ³•æµç¨‹**ï¼š

```typescript
async function calculateAvailableSlots(teacher: any, date: string, duration: number) {
  // 1. è·å–ç›®æ ‡æ—¥æœŸçš„æ˜ŸæœŸå‡ 
  const dayOfWeek = getDay(targetDate) // 0 = å‘¨æ—¥, 1 = å‘¨ä¸€, ...
  
  // 2. æŸ¥æ‰¾è¯¥æ—¥æœŸçš„å¯ç”¨æ—¶é—´è®¾ç½®
  const dayAvailability = teacher.availability.find(avail => avail.dayOfWeek === dayOfWeek)
  
  // 3. ç”ŸæˆåŸºç¡€æ—¶é—´æ§½ï¼ˆæŒ‰ duration åˆ†é’Ÿåˆ‡ç‰‡ï¼‰
  const allSlots = generateTimeSlots(dayAvailability.startTime, dayAvailability.endTime, duration)
  
  // 4. è¿‡æ»¤å†²çªæ—¶é—´æ§½
  const availableSlots = filterConflictingSlots(allSlots, teacher, targetDate, duration)
  
  return availableSlots.map(slot => slot.toISOString())
}
```

**å…³é”®æ­¥éª¤è¯¦è§£**ï¼š

1. **æ—¶é—´æ§½ç”Ÿæˆ**ï¼š
   ```typescript
   // ä» startTime åˆ° endTimeï¼ŒæŒ‰ duration åˆ†é’Ÿé—´éš”ç”Ÿæˆ
   while (currentTime < slotEnd) {
     allSlots.push(new Date(currentTime))
     currentTime = addMinutes(currentTime, duration)
   }
   ```

2. **å†²çªæ£€æµ‹**ï¼š
   - é˜»å¡æ—¶é—´å†²çªæ£€æµ‹
   - å·²æœ‰é¢„çº¦å†²çªæ£€æµ‹ï¼ˆåŒ…å«ç¼“å†²æ—¶é—´ï¼‰
   - è¶…å‡ºç»“æŸæ—¶é—´çš„æ§½ä½è¿‡æ»¤

3. **ç¼“å†²æ—¶é—´å¤„ç†**ï¼š
   ```typescript
   // æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰é¢„çº¦å†²çªï¼ˆåŒ…å«ç¼“å†²æ—¶é—´ï¼‰
   const bufferStart = addMinutes(slot, -teacher.bufferMinutes)
   const bufferEnd = addMinutes(slotEndTime, teacher.bufferMinutes)
   ```

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- ç¼“å­˜æœºåˆ¶ï¼š5åˆ†é’Ÿ TTL ç¼“å­˜çƒ­é—¨æŸ¥è¯¢ç»“æœ
- æ‰¹é‡æŸ¥è¯¢ï¼šä¸€æ¬¡æ€§è·å–æ‰€æœ‰ç›¸å…³æ•°æ®
- å†…å­˜è¿‡æ»¤ï¼šåœ¨åº”ç”¨å±‚è¿›è¡Œæ—¶é—´å†²çªè®¡ç®—

## 12.2 æ£€æŸ¥é‡å çš„é¢„çº¦å’Œé˜»å¡æ—¶é—´

### æ ¸å¿ƒç®—æ³•ï¼š`detectAvailabilityConflicts()`

**åŠŸèƒ½æè¿°**ï¼šæ£€æµ‹æ•™å¸ˆè®¾ç½®å¯ç”¨æ—¶é—´æ—¶ä¸ç°æœ‰é¢„çº¦ã€é˜»å¡æ—¶é—´çš„å†²çªæƒ…å†µã€‚

**å†²çªç±»å‹åˆ†ç±»**ï¼š

```typescript
interface TimeConflict {
  type: 'exact_match' | 'overlap' | 'contained' | 'contains' | 'blocked_time' | 'appointment'
  message: string
  existingSlot?: TeacherAvailability
  blockedTime?: BlockedTime
  appointment?: Appointment
  overlap?: string
}
```

**å†²çªæ£€æµ‹ç®—æ³•**ï¼š

1. **æ—¶é—´é‡å åˆ†æ**ï¼š
   ```typescript
   function analyzeTimeOverlap(start1: string, end1: string, start2: string, end2: string) {
     const s1 = parseTime(start1), e1 = parseTime(end1)
     const s2 = parseTime(start2), e2 = parseTime(end2)
     
     if (s1 === s2 && e1 === e2) return { type: 'exact_match' }
     if (s1 < e2 && s2 < e1) return { type: 'overlap', overlap: calculateOverlap(s1, e1, s2, e2) }
     if (s1 <= s2 && e1 >= e2) return { type: 'contains' }
     if (s1 >= s2 && e1 <= e2) return { type: 'contained' }
     return { type: 'no_overlap' }
   }
   ```

2. **é¢„çº¦å†²çªæ£€æµ‹**ï¼š
   ```typescript
   async function checkAppointmentConflicts(teacherId: string, request: AvailabilityRequest) {
     const appointments = await prisma.appointment.findMany({
       where: {
         teacherId,
         status: { in: ['pending', 'approved'] }
       }
     })
     
     // æ£€æŸ¥æ¯ä¸ªé¢„çº¦çš„æ—¶é—´é‡å 
     return appointments.filter(appointment => {
       const overlap = analyzeTimeOverlap(
         appointment.startTime, appointment.endTime,
         request.startTime, request.endTime
       )
       return overlap.type !== 'no_overlap'
     })
   }
   ```

3. **é˜»å¡æ—¶é—´å†²çªæ£€æµ‹**ï¼š
   ```typescript
   async function checkBlockedTimeConflicts(teacherId: string, request: AvailabilityRequest) {
     const blockedTimes = await prisma.blockedTime.findMany({ where: { teacherId } })
     
     return blockedTimes.filter(blocked => {
       const overlap = analyzeTimeOverlap(
         blocked.startTime, blocked.endTime,
         request.startTime, request.endTime
       )
       return overlap.type !== 'no_overlap'
     })
   }
   ```

**æ™ºèƒ½å†²çªè§£å†³å»ºè®®**ï¼š

```typescript
function generateConflictSuggestions(conflicts: TimeConflict[], request: AvailabilityRequest) {
  const suggestions = []
  
  if (conflicts.some(c => c.type === 'overlap')) {
    suggestions.push('å»ºè®®è°ƒæ•´æ—¶é—´æ®µï¼Œé¿å…ä¸ç°æœ‰æ—¶é—´é‡å ')
  }
  
  if (conflicts.some(c => c.type === 'exact_match')) {
    suggestions.push('è¯¥æ—¶é—´æ®µå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´')
  }
  
  if (conflicts.some(c => c.type === 'blocked_time')) {
    suggestions.push('å»ºè®®å…ˆç§»é™¤é˜»å¡æ—¶é—´ï¼Œæˆ–é€‰æ‹©å…¶ä»–æ—¶é—´æ®µ')
  }
  
  return suggestions
}
```

## 12.3 é¢„çº¦å†²çªæ£€æµ‹ç®—æ³•

### æ ¸å¿ƒç®—æ³•ï¼š`checkAppointmentConflicts()`

**åŠŸèƒ½æè¿°**ï¼šåœ¨åˆ›å»ºæ–°é¢„çº¦æ—¶ï¼Œæ£€æµ‹ä¸ç°æœ‰é¢„çº¦çš„æ—¶é—´å†²çªã€‚

**å†²çªæ£€æµ‹æµç¨‹**ï¼š

1. **æ—¶é—´èŒƒå›´è®¡ç®—**ï¼š
   ```typescript
   const scheduledTime = new Date(validatedData.scheduledTime)
   const slotEnd = addMinutes(scheduledTime, validatedData.durationMinutes)
   
   // åŒ…å«ç¼“å†²æ—¶é—´çš„å®Œæ•´èŒƒå›´
   const bufferStart = addMinutes(scheduledTime, -teacher.bufferMinutes)
   const bufferEnd = addMinutes(slotEnd, teacher.bufferMinutes)
   ```

2. **å†²çªæŸ¥è¯¢**ï¼š
   ```typescript
   const conflictingAppointments = await prisma.appointment.findMany({
     where: {
       teacherId: validatedData.teacherId,
       scheduledTime: { lt: bufferEnd },
       status: { in: ['pending', 'approved'] }
     }
   })
   ```

3. **é‡å åˆ¤æ–­**ï¼š
   ```typescript
   const hasConflict = conflictingAppointments.some(appointment => {
     const appointmentEnd = addMinutes(appointment.scheduledTime, appointment.durationMinutes)
     return bufferStart < appointmentEnd && bufferEnd > appointment.scheduledTime
   })
   ```

**è¾¹ç•Œæƒ…å†µå¤„ç†**ï¼š
- ç¼“å†²æ—¶é—´ï¼šæ•™å¸ˆè®¾ç½®çš„ `bufferMinutes` ç¡®ä¿é¢„çº¦é—´æœ‰è¶³å¤Ÿé—´éš”
- çŠ¶æ€è¿‡æ»¤ï¼šåªæ£€æŸ¥ `pending` å’Œ `approved` çŠ¶æ€çš„é¢„çº¦
- æ—¶é—´ç²¾åº¦ï¼šä½¿ç”¨æ¯«ç§’çº§ç²¾åº¦è¿›è¡Œæ—¶é—´æ¯”è¾ƒ
