# æ•™è‚²è°ƒåº¦ç³»ç»Ÿè®¾è®¡è¯´æ˜

# ä¸€ã€ ä¸šåŠ¡åŠŸèƒ½è¯´æ˜

> è¯¥ç³»ç»Ÿæ˜¯ç»™å­¦æ ¡ä½¿ç”¨çš„å¹³å°ã€‚å­¦ç”Ÿåœ¨å¹³å°é€‰æ‹©è€å¸ˆå’Œé¢„çº¦è¯¥è€å¸ˆçš„è¾…å¯¼ï¼Œè€å¸ˆåœ¨å¹³å°è®¾ç½®è‡ªå·±çš„å¯é¢„çº¦æ—¶é—´æ®µå¹¶å¯¹å­¦ç”Ÿé¢„çº¦è¿›è¡Œå®¡æ‰¹ï¼›ç³»ç»Ÿæ ¹æ®ä¸åŒçš„â€œæœåŠ¡çº§åˆ«â€è‡ªåŠ¨/äººå·¥æ‰¹å‡†ï¼Œé™åˆ¶æ¯æœˆæ¬¡æ•°ï¼Œå¹¶é¿å…å†²çªã€‚

## 1.1 è§’è‰²ä¸æƒé™

- **å­¦ç”Ÿï¼ˆstudentï¼‰**ï¼šæŸ¥è¯¢è€å¸ˆåŠå…¶å¯ç”¨æ—¶æ®µã€å‘èµ·é¢„çº¦ã€æŸ¥çœ‹/å–æ¶ˆé¢„çº¦ã€æ¥æ”¶é€šçŸ¥ã€‚
- **æ•™å¸ˆï¼ˆteacherï¼‰**ï¼šé…ç½®å¯ç”¨æ—¶æ®µã€è®¾ç½®é˜»å¡æ—¶é—´ã€å®¡æ‰¹/æ‹’ç»é¢„çº¦ã€æŸ¥çœ‹è‡ªå·±çš„æ—¥ç¨‹ã€‚
- **ç®¡ç†å‘˜ï¼ˆadminï¼‰**ï¼šç®¡ç†æœåŠ¡çº§åˆ«ç­–ç•¥ã€é…é¢ã€é˜ˆå€¼ã€ç§‘ç›®ã€å…¨å±€è¿è¥æŠ¥è¡¨ã€å®¡è®¡æ—¥å¿—ã€‚

## 1.2 æœåŠ¡çº§åˆ«é€»è¾‘

- **Level1**ï¼šæ¯æœˆ 2 æ¬¡è‡ªåŠ¨æ‰¹å‡†ï¼Œé¢å¤–éœ€å®¡æ‰¹ã€‚
- **Level2**ï¼šæ‰€æœ‰ä¼šè®®å‡éœ€å®¡æ‰¹ã€‚
- **Premium**ï¼šå…¨éƒ¨è‡ªåŠ¨æ‰¹å‡†ï¼Œä¸”æœ‰ä¼˜å…ˆæƒã€‚
- **ç§‘ç›®é™åˆ¶**ï¼šå­¦ç”Ÿä»…èƒ½é¢„çº¦æ•™æˆå…¶**å·²æ³¨å†Œç§‘ç›®**çš„æ•™å¸ˆã€‚
- **æœˆåº¦é‡ç½®**ï¼šæ¯æœˆ 1 æ—¥é…é¢è®¡æ•°æ¸…é›¶ï¼ˆä»¥ç³»ç»Ÿæ—¶åŒºä¸ºå‡†ï¼‰

## 1.3 åŠŸèƒ½æ¸…å•ä¸è¯´æ˜

| è§’è‰² | åŠŸèƒ½             | è¯´æ˜                                            | å…³é”®è§„åˆ™                                                                |
| ---- | ---------------- | ----------------------------------------------- | ----------------------------------------------------------------------- |
| å­¦ç”Ÿ | æœç´¢æ•™å¸ˆå¯ç”¨æ§½ä½ | æ ¹æ®æ•™å¸ˆä¸æ—¥æœŸè¿”å›å¯é¢„çº¦å¼€å§‹æ—¶é—´åˆ—è¡¨            | éµå®ˆ availabilityã€blockedã€appointmentsã€bufferï¼Œä¸è¶… maxDailyMeetings |
| å­¦ç”Ÿ | åˆ›å»ºé¢„çº¦         | å­¦ç”Ÿé€‰æ‹©æ§½ä½åˆ›å»ºé¢„çº¦                            | ç§‘ç›®åŒ¹é…ã€æœåŠ¡çº§åˆ«è·¯ç”±ã€æ§½ä½å ç”¨æ£€æŸ¥ã€å¹‚ç­‰                              |
| å­¦ç”Ÿ | å–æ¶ˆé¢„çº¦         | åœ¨å…è®¸çš„æ—¶é™å†…å–æ¶ˆï¼ˆä¾‹å¦‚ä¼šè®®å¼€å§‹å‰â‰¥2hï¼Œå¯é…ç½®ï¼‰ | å·²å®Œæˆ/å·²è¿‡æœŸä¸å¯å–æ¶ˆï¼›å†™å®¡è®¡                                           |
| å­¦ç”Ÿ | é¢„çº¦æ”¹æœŸ         | å–å†³äºæ˜¯å¦æ”¯æŒâ€œç§»åŠ¨â€é¢„çº¦ï¼›é»˜è®¤å®ç°ä¸ºâ€œå–æ¶ˆ+æ–°å»ºâ€ | æ”¹æœŸéœ€é‡è¿‡å†²çªä¸é…é¢æ ¡éªŒ                                                |
| å­¦ç”Ÿ | æŸ¥çœ‹æˆ‘çš„é¢„çº¦     | æŒ‰çŠ¶æ€/æ—¶é—´èŒƒå›´åˆ†é¡µæŸ¥è¯¢                         | é»˜è®¤å‡åº                                                                |
| æ•™å¸ˆ | ç»´æŠ¤æ¯å‘¨å¯ç”¨æ€§   | è®¾ç½®/æ›´æ–° dayOfWeek + start/end                 | åŒä¸€å¤©å¯å¤šä¸ªåŒºé—´                                                        |
| æ•™å¸ˆ | ç»´æŠ¤é˜»å¡æ—¶é—´     | è®°å½•ä¸€æ®µä¸å¯é¢„çº¦æ—¶é—´ï¼ˆä¸Šè¯¾/å¼€ä¼šç­‰ï¼‰             | ä¸é¢„çº¦å†²çªæ—¶æç¤ºé£é™©                                                    |
| æ•™å¸ˆ | å®¡æ‰¹/æ‹’ç»é¢„çº¦    | å¯¹æ‰€æœ‰pending æ‰§è¡Œ approve/cancel               | è®°å½•åŸå› ã€æ—¶é—´ï¼›é€šçŸ¥                                                    |
| ç®¡ç† | æœåŠ¡çº§åˆ«ç­–ç•¥     | é…é¢é˜ˆå€¼ã€è¶…æ—¶é˜ˆå€¼ã€æé†’ç­–ç•¥ç­‰å‚æ•°åŒ–            | å¯åç»­æŠ½è±¡ä¸ºç­–ç•¥è¡¨                                                      |
| ç³»ç»Ÿ | 48h å¾…å®¡æ‰¹è¿‡æœŸ   | å®šæ—¶æ‰«æ pending è¶…æ—¶â†’expired                   | å‘é€è¿‡æœŸé€šçŸ¥                                                            |
| ç³»ç»Ÿ | æœˆåˆé…é¢é‡ç½®     | æ¯æœˆ1æ—¥é‡ç½® Level1/2 é…é¢è®¡æ•°                   | æ›´æ–°æ—¶é—´æˆ³                                                              |
| ç³»ç»Ÿ | æé†’é€šçŸ¥         | T-24h / T-1h æé†’å­¦ç”Ÿ&æ•™å¸ˆ                      | é˜Ÿåˆ—/å®šæ—¶è§¦å‘                                                           |
| ç³»ç»Ÿ | å€™è¡¥é˜Ÿåˆ—         | è‹¥çƒ­é—¨æ—¶æ®µè¢«å ï¼Œå¯åŠ å…¥å€™è¡¥ï¼›é‡Šæ”¾æ—¶è‡ªåŠ¨é¡¶æ›¿      | é¡¶æ›¿åé€šçŸ¥åŒæ–¹                                                          |

# äºŒã€ç³»ç»Ÿæ•´ä½“è®¾è®¡ä¸æ¶æ„

## 2.1 æ•´ä½“æ¶æ„

```mermaid
graph TD
  Client[Web/Mobile Client] -->|HTTPS/REST| API[Next.js API Routes]
  API --> Auth[Auth Service]
  API --> Scheduler[Scheduler Service]
  API --> Teacher[Teacher Service]
  API --> Admin[Admin Service]
  API --> Queue[Message Queue]
  Queue --> Mailer[Notification Service]
  API --> DB[(PostgreSQL)]
  API --> Cache[(Redis)]
```

**è¯´æ˜ï¼š**

- **Auth Service**ï¼šè´Ÿè´£ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€JWT æ ¡éªŒã€é‚€è¯·ç æ³¨å†Œã€‚
- **Scheduler Service**ï¼šè´Ÿè´£é¢„çº¦é€»è¾‘ï¼ˆå¯ç”¨æ§½ä½è®¡ç®—ã€å†²çªæ ¡éªŒã€é…é¢è¿½è¸ªã€å®¡æ‰¹å·¥ä½œæµï¼‰ã€‚
- **Teacher Service**ï¼šæ•™å¸ˆå¯ç”¨æ€§ã€é˜»å¡æ—¶é—´ã€å®¡æ‰¹ã€‚
- **Admin Service**ï¼šç­–ç•¥ç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€å®¡è®¡æŸ¥è¯¢ã€‚
- **Notification Service**ï¼šæé†’é€šçŸ¥ã€è¿‡æœŸé€šçŸ¥ï¼ˆå½“å‰ç›´æ¥ç”± API è°ƒç”¨é‚®ä»¶æœåŠ¡ï¼Œæ— ç‹¬ç«‹é˜Ÿåˆ—ï¼‰ã€‚
- **Database**ï¼šPostgreSQLï¼ŒåŒ…å«è®¤è¯è¡¨ã€ä¸šåŠ¡è¡¨ã€å®¡è®¡è¡¨ã€‚
- **Cache**ï¼šå†…å­˜ç¼“å­˜ä¸ºä¸»ï¼Œæ”¯æŒå¯é€‰ Redisï¼ˆé…ç½® `REDIS_URL` åå¯ç”¨ï¼‰ã€‚
- **Message Queue**ï¼šè§„åˆ’é¡¹ï¼Œå½“å‰æœªè½åœ°ï¼ˆåç»­å¯å¯¹æ¥ Kafka/RabbitMQï¼‰ã€‚

# ä¸‰ã€æ¨¡å—è®¾è®¡

## **3.1 ç”¨æˆ·æ³¨å†Œä¸ç™»å½•æ¨¡å—**

### 3.1.1 å­¦ç”Ÿæ³¨å†Œ/ç™»å½•

**æ³¨å†Œæ­¥éª¤**

- è‡ªåŠ©æ³¨å†Œï¼šä»…å…è®¸åˆ›å»º `role=student`ã€‚
- è¡¨å•ï¼šemailã€passwordã€ï¼ˆå¯é€‰ï¼‰å§“åã€å¹´çº§ã€`enrolledSubjects` åˆå§‹åŒ–ã€‚
- æ ¡éªŒï¼šé‚®ç®±å”¯ä¸€+å¯†ç å¼ºåº¦ï¼›å†™å…¥ `users(status=pending)` ä¸ `students` æ‰©å±•è¡¨ï¼›å‘éªŒè¯é‚®ä»¶ã€‚
- æ¿€æ´»ï¼šç‚¹å‡»é‚®ä»¶é­”æ³•é“¾æ¥ â†’ `users.status=active`ã€‚

**ç™»å½•æ­¥éª¤**

- è¾“å…¥ email/password â†’ æ ¡éªŒ `users.status in ('active')` â†’ è¿”å› `accessToken(15min)` ä¸ `refreshToken(30d)`
- è®°å½• `last_login_at`ï¼Œå†™å®¡è®¡æ—¥å¿—ï¼ˆaction=loginï¼‰ã€‚

### 3.1.2 æ•™å¸ˆæ³¨å†Œ/ç™»å½•

**æ³¨å†Œæ­¥éª¤**

- æ¨èâ€œå—é‚€æ³¨å†Œâ€ï¼šç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜é¢„åˆ›å»ºâ€œæ•™å¸ˆé‚€è¯·â€ï¼ˆè§ 3.1.3ï¼‰ï¼Œæ•™å¸ˆé€šè¿‡é‚€è¯·é‚®ä»¶å®Œæˆæ³¨å†Œä¸æ¿€æ´»ã€‚
- ä¹Ÿå¯å¼€æ”¾â€œè‡ªåŠ©æ³¨å†Œâ€ä½†éœ€æ·»åŠ â€œäººå·¥å®¡æ ¸é€šè¿‡åç”Ÿæ•ˆâ€çš„å¼€å…³ï¼ˆæœºæ„å¯é…ç½®ï¼‰ï¼Œä»¥é˜²ä¼ªå†’æ•™å¸ˆã€‚

**ç™»å½•æ­¥éª¤**

- åŒå­¦ç”Ÿï¼›æ¿€æ´»åå¯ç™»å½•ï¼Œå®Œå–„ `subjects/maxDailyMeetings/bufferMinutes` ç­‰ã€‚

```mermaid
sequenceDiagram
participant U as User(å­¦ç”Ÿ/æ•™å¸ˆ)
participant W as WebApp
participant API as API Gateway
participant AUTH as AuthService
participant DB as DB
participant MAIL as MailService

U->>W: å¡«å†™é‚®ç®±+å¯†ç æäº¤æ³¨å†Œ
W->>API: POST /api/auth/register
API->>AUTH: æ ¡éªŒå”¯ä¸€æ€§/å¼ºåº¦
AUTH->>DB: æ–°å»º users(status=pending)
AUTH->>MAIL: å‘é€æ¿€æ´»é‚®ä»¶(ä¸€æ¬¡æ€§token)
U->>MAIL: ç‚¹å‡»æ¿€æ´»é“¾æ¥
MAIL->>AUTH: éªŒè¯token
AUTH->>DB: users.status=active
AUTH-->>W: æ³¨å†Œå®Œæˆ(å¯ç™»å½•)

U->>W: è¾“å…¥é‚®ç®±/å¯†ç ç™»å½•
W->>API: POST /api/auth/login
API->>AUTH: æ ¡éªŒå‡­æ®/çŠ¶æ€=active
AUTH->>DB: è®°å½•last_login_at/å†™åˆ·æ–°ä»¤ç‰Œ
AUTH-->>W: Set-Cookie(HttpOnly) Access(çŸ­) + Refresh(é•¿)

```

### 3.1.3 ç®¡ç†å‘˜ç™»å½•ï¼ˆå«è¶…çº§ç®¡ç†å‘˜å¼•å¯¼ï¼‰

**åˆå§‹åŒ–è¶…çº§ç®¡ç†å‘˜ï¼ˆä¸€æ¬¡æ€§ï¼‰**

- é¦–æ¬¡éƒ¨ç½²æ—¶ï¼Œé€šè¿‡â€œå¼•å¯¼å£ä»¤ï¼ˆenvï¼‰+å—æ§å…¥å£â€å®Œæˆè¶…çº§ç®¡ç†å‘˜ï¼ˆ`role=admin,is_super=true`ï¼‰åˆ›å»ºã€‚
- åˆ›å»ºæˆåŠŸå**è‡ªåŠ¨å¤±æ•ˆ**å¼•å¯¼å£ä»¤ï¼Œé¿å…é‡æ”¾ã€‚

**ç®¡ç†å‘˜åˆ›å»ºä¸æƒé™**

- ç®¡ç†å‘˜è´¦å·ä»…èƒ½ç”±**è¶…çº§ç®¡ç†å‘˜**åˆ›å»ºï¼ˆæˆ–å‘å‡ºâ€œç®¡ç†å‘˜é‚€è¯·â€ï¼‰ï¼›æ™®é€šç®¡ç†å‘˜ä¸å¯è‡ªåŠ©æ³¨å†Œã€‚
- ç®¡ç†å‘˜æ‹¥æœ‰åå°ç®¡ç†å…¥å£ï¼Œå¯ç®¡ç†ç­–ç•¥/ç”¨æˆ·ä¸å®¡è®¡ï¼Œä½†ä¸èƒ½è¶Šæƒææƒã€‚
- æ™®é€šç®¡ç†å‘˜ï¼šå¯ç™»å½•ä¸ä¿®æ”¹è‡ªå·±å¯†ç ï¼›**ä¸èƒ½**åˆ›å»ºæ–°ç®¡ç†å‘˜ã€‚

```mermaid
sequenceDiagram
participant OP as DevOps
participant API as API Gateway
participant AUTH as AuthService
participant DB as DB
participant MAIL as MailService
participant SA as SuperAdmin
participant ADM as Admin(è¢«é‚€è¯·è€…)

OP->>API: POST /api/admin/bootstrap {bootstrapSecret}
API->>AUTH: æ ¡éªŒå¼•å¯¼å£ä»¤(ä»…ä¸€æ¬¡)
AUTH->>DB: åˆ›å»º users(role=admin,is_super=true,active)
AUTH-->>OP: åˆå§‹åŒ–å®Œæˆ(å£ä»¤å¤±æ•ˆ)

SA->>API: POST /api/admin/users(invite admin)
API->>AUTH: ç”Ÿæˆadmin_invite_token
AUTH->>DB: å†™å…¥é‚€è¯·
AUTH->>MAIL: å‘é‚€è¯·é‚®ä»¶

ADM->>MAIL: ç‚¹å‡»é‚€è¯·é“¾æ¥
MAIL->>AUTH: éªŒè¯token
AUTH->>DB: åˆ›å»º users(role=admin,active)
AUTH-->>ADM: è®¾ç½®å¯†ç å¹¶ç™»å½•åå°

```

æ³¨ï¼šä¸Šè¿°â€œå¼•å¯¼å£ä»¤ / ç®¡ç†å‘˜é‚€è¯·â€æµç¨‹ä¸ºè§„åˆ’è®¾è®¡ï¼Œå½“å‰æœªå®ç°ï¼›å®é™…ç®¡ç†ç«¯æ¥å£ä»¥ç°æœ‰çš„ `/api/admin/*` è·¯ç”±ä¸ºå‡†ã€‚

### 3.1.4 ç™»å½•/åˆ·æ–°/ç™»å‡º

```mermaid
sequenceDiagram
participant U as User
participant W as WebApp
participant API as API Gateway
participant AUTH as AuthService
participant DB as DB

U->>W: è¾“å…¥é‚®ç®±/å¯†ç 
W->>API: POST /api/auth/login
API->>AUTH: æ ¡éªŒå‡­æ®/çŠ¶æ€
AUTH->>DB: è®°å½•last_login/å†™refresh_token
AUTH-->>W: Set-Cookie Access(15m)+Refresh(30d)

Note over W: Accessè¿‡æœŸåé™é»˜åˆ·æ–°
W->>API: POST /api/auth/refresh (å¸¦Refresh Cookie)
API->>AUTH: éªŒè¯å¹¶è½®æ¢refresh_token
AUTH->>DB: æ—§refresh_token.revoked=trueï¼Œå†™æ–°token
AUTH-->>W: æ–°Access + æ–°Refresh(Set-Cookie)

U->>W: ç‚¹å‡»é€€å‡º
W->>API: POST /api/auth/logout
API->>AUTH: å½“å‰refresh_token.revoked=true
AUTH-->>W: 204 No Content

```

## 3.2 å­¦ç”Ÿï½œæœç´¢æ•™å¸ˆå¯ç”¨æ§½ä½

**ç›®æ ‡**ï¼šæ ¹æ®æ•™å¸ˆä¸æ—¥æœŸè¿”å›å¯é¢„çº¦å¼€å§‹æ—¶é—´åˆ—è¡¨ã€‚

**å…³é”®è§„åˆ™**ï¼šéµå®ˆ `availability`ã€`blocked_times`ã€`appointments`ã€`buffer`ï¼Œä¸è¶… `maxDailyMeetings`ã€‚

**æ­¥éª¤**ï¼š

1. å‰ç«¯æ”¶é›† `teacherId/date/duration` è°ƒç”¨ APIã€‚
2. æœåŠ¡å™¨å…ˆæŸ¥ç¼“å­˜ï¼›æœªå‘½ä¸­åˆ™ï¼š
   - è¯»æ•™å¸ˆå½“æ—¥ `availability`ï¼›
   - è¯»å½“æ—¥ `appointments(status in [pending,approved])`ï¼›
   - è¯» `blocked_times`ï¼›
   - è¯»å– `bufferMinutes/maxDailyMeetings`ï¼›
   - é€æ§½ä½åˆ‡ç‰‡å¹¶åš**åŒºé—´é‡å  + ç¼“å†²**æ£€æµ‹ï¼›
   - å¯æŒ‰ `maxDailyMeetings` æˆªæ–­ï¼›
   - å†™å…¥çŸ­æœŸç¼“å­˜è¿”å›ã€‚
3. å“åº” `slots[]`ï¼ˆUTCï¼‰ï¼Œå‰ç«¯æŒ‰ç”¨æˆ·æ—¶åŒºæ¸²æŸ“ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API (Slots)
participant C as Cache
participant D as DB
U->>W: é€‰æ‹© teacherId + date (+ duration)
W->>A: GET /api/slots?teacherId&date&duration
A->>C: GET slots:{tid}:{date}:{duration}
alt ç¼“å­˜å‘½ä¸­
C-->>A: è¿”å› slots[]
else æœªå‘½ä¸­
A->>D: è¯» availability/appointments/blocked_times/teacher
A->>A: åˆ‡ç‰‡ duration + buffer å†²çªæ£€æµ‹ + å½“æ—¥ä¸Šé™
A->>C: SET slots é”® (TTL 1-5m)
end
A-->>W: slots[] (ISO8601 UTC)
```

## 3.3 å­¦ç”Ÿï½œåˆ›å»ºé¢„çº¦

**ç›®æ ‡**ï¼šå­¦ç”Ÿé€‰æ‹©æ§½ä½åˆ›å»ºé¢„çº¦ã€‚

**å…³é”®è§„åˆ™**ï¼šç§‘ç›®åŒ¹é…ã€æœåŠ¡çº§åˆ«è·¯ç”±ã€æ§½ä½å ç”¨æ£€æŸ¥ã€å¹‚ç­‰ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒä¸»ä½“ï¼šå­¦ç”Ÿ/æ•™å¸ˆå­˜åœ¨ã€`subject` åŒæ—¶åŒ…å«äº `student.enrolledSubjects` ä¸ `teacher.subjects`ã€‚
2. **æ§½ä½å¯ç”¨æ€§**ï¼šå¯ç›´æ¥é‡è·‘ `generateAvailableSlots()` å¹¶æ ¡éªŒ `scheduledTime` åœ¨è¿”å›é›†å†…ï¼ˆè§„é¿å¹¶å‘ï¼‰ã€‚
3. **æœåŠ¡çº§åˆ«è·¯ç”±**ï¼š
   - Level1ï¼šè‹¥ `monthlyMeetingsUsed < 2` â†’ `approved`ï¼Œå¹¶åœ¨äº‹åŠ¡å†… +1ï¼›å¦åˆ™ `pending`ï¼›
   - Level2ï¼š`pending`ï¼›
   - Premiumï¼š`approved`ï¼ˆå¯é€‰ï¼šæŠ¢å ä½ä¼˜å…ˆçº§ `pending`ï¼‰ã€‚
4. **å¹‚ç­‰**ï¼šä½¿ç”¨ `idempotencyKey` å”¯ä¸€é”®ï¼›é‡å¤æäº¤è¿”å›å·²åˆ›å»ºè®°å½•ã€‚
5. **ç¼“å­˜å¤±æ•ˆ**ï¼šåˆ é™¤ç›¸å…³ `slots:{tid}:{date}:{duration}`ã€‚
6. **é€šçŸ¥**ï¼šæ ¹æ®ç»“æœå‘é€é‚®ä»¶ï¼ˆå·²æ‰¹æ ¸/ç­‰å¾…å®¡æ‰¹ï¼‰ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API (Appointments)
participant D as DB
participant C as Cache
participant E as Email
U->>W: é€‰æ‹©æ§½ä½å¹¶æäº¤
W->>A: POST /api/appointments {studentId,teacherId,subject,scheduledTime,duration,idempotencyKey}
A->>D: æ ¡éªŒå­¦ç”Ÿ/æ•™å¸ˆ/ç§‘ç›®åŒ¹é…
A->>A: æœåŠ¡çº§åˆ«å†³ç­– approved|pendingï¼ˆLevel1/2/Premiumï¼‰
A->>D: äº‹åŠ¡: å†™å…¥é¢„çº¦(+å¿…è¦æ—¶é€’å¢é…é¢)
A->>C: å¤±æ•ˆ slots ç¼“å­˜é”®
A->>E: å‘é€ç¡®è®¤/å¾…å®¡æ‰¹é€šçŸ¥(å¼‚æ­¥)
A-->>W: 201 {status, approvalRequired}
```

## 3.4 å­¦ç”Ÿï½œå–æ¶ˆé¢„çº¦

**ç›®æ ‡**ï¼šå…è®¸åœ¨ä¼šè®®å¼€å§‹å‰â‰¥2hï¼ˆå¯é…ç½®ï¼‰å–æ¶ˆã€‚

**å…³é”®è§„åˆ™**ï¼š`completed/expired` ä¸å¯å–æ¶ˆï¼›å†™å®¡è®¡ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒè¯·æ±‚è€…ä¸ºè¯¥é¢„çº¦çš„å­¦ç”Ÿï¼›
2. æ ¡éªŒ `now <= scheduledTime - cancelWindow(2h)`ï¼›
3. çŠ¶æ€å…è®¸ï¼š`pending|approved`ï¼›
4. æ›´æ–°ä¸º `cancelled`ï¼Œå†™å®¡è®¡ä¸å¯é€‰çš„å–æ¶ˆåŸå› ï¼›
5. å¤±æ•ˆæ§½ä½ç¼“å­˜ï¼›é€šçŸ¥ç›¸å…³æ•™å¸ˆã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API (Appointments)
participant D as DB
participant C as Cache
participant E as Email
U->>W: ç‚¹å‡»å–æ¶ˆ
W->>A: PATCH /api/appointments/{id} {action: cancel}
A->>D: è¯»å–é¢„çº¦å¹¶æ ¡éªŒæƒé™/æ—¶é—´çª—å£
A->>D: æ›´æ–°ä¸º cancelled, è®°å½•åŸå› 
A->>C: å¤±æ•ˆ slots ç¼“å­˜(æ‰€åœ¨æ—¥æœŸ/æ•™å¸ˆ)
A->>E: é€šçŸ¥æ•™å¸ˆ
A-->>W: 200 OK
```

## 3.5 å­¦ç”Ÿï½œé¢„çº¦æ”¹æœŸ

**ç›®æ ‡**ï¼šé»˜è®¤ä»¥â€œå–æ¶ˆ+æ–°å»ºâ€å®ç°ã€‚

**å…³é”®è§„åˆ™**ï¼šæ–°å»ºéœ€é‡æ–°é€šè¿‡**å†²çªä¸é…é¢**æ ¡éªŒã€‚

**æ­¥éª¤**ï¼š

1. å…ˆæŒ‰ **å–æ¶ˆ**è§„åˆ™å¤„ç†æ—§é¢„çº¦ï¼›
2. ä½¿ç”¨æ–°æ§½ä½æŒ‰ **åˆ›å»º**æµç¨‹é‡å»ºï¼›
3. ï¼ˆå¯é€‰ï¼‰æä¾›å•äº‹åŠ¡â€œç§»åŠ¨é¢„çº¦â€æ¥å£ï¼Œéœ€è¦æ›´å¤æ‚çš„åŒºé—´é”ä¸å†²çªå¤„ç†ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API
participant D as DB
U->>W: é€‰æ‹©æ–°çš„æ§½ä½
W->>A: PATCH /api/appointments/{id} {action: cancel}
A->>D: å–æ¶ˆæ—§é¢„çº¦ (æ ¡éªŒæ—¶é—´çª—å£)
W->>A: POST /api/appointments {newSlot,...}
A->>D: èµ°åˆ›å»ºæµç¨‹(ç§‘ç›®/æœåŠ¡çº§åˆ«/å¹‚ç­‰/å†²çª)
A-->>W: è¿”å›æ–°é¢„çº¦
```

## 3.6 å­¦ç”Ÿï½œæŸ¥çœ‹æˆ‘çš„é¢„çº¦

**ç›®æ ‡**ï¼šæŒ‰çŠ¶æ€/æ—¶é—´èŒƒå›´åˆ†é¡µæŸ¥è¯¢ï¼Œé»˜è®¤æŒ‰æ—¶é—´å‡åºã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒèº«ä»½ï¼›
2. ç»„åˆ where æ¡ä»¶ä¸æ—¶é—´èŒƒå›´ï¼›
3. æ¸¸æ ‡åˆ†é¡µè¿”å›åˆ—è¡¨ä¸ä¸‹ä¸€é¡µæ¸¸æ ‡ã€‚

```mermaid
sequenceDiagram
participant U as Student
participant W as Web
participant A as API
participant D as DB
U->>W: é€‰æ‹©ç­›é€‰æ¡ä»¶
W->>A: GET /api/appointments?role=student&status&from&to
A->>D: æŸ¥è¯¢å¹¶æŒ‰ scheduledTime å‡åº/æ¸¸æ ‡åˆ†é¡µ
D-->>A: items[]
A-->>W: items[] + nextCursor
```

## 3.7 æ•™å¸ˆï½œç»´æŠ¤æ¯å‘¨å¯ç”¨æ€§

**ç›®æ ‡**ï¼šè®¾ç½®/æ›´æ–° `dayOfWeek + start/end`ï¼ŒåŒä¸€å¤©å¯å¤šä¸ªåŒºé—´ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒæ•™å¸ˆèº«ä»½ä¸å­—æ®µåˆæ³•æ€§ï¼›
2. æ–°å¢æˆ–è¦†ç›–åŒºé—´ï¼ˆé¿å…äº¤å‰é‡å çš„å¯é€‰æ ¡éªŒï¼‰ï¼›
3. å¤±æ•ˆæœªæ¥è‹¥å¹²å¤©çš„ `slots` ç¼“å­˜é”®ï¼ˆæˆ–æ ‡è®°ä¸ºè„ï¼‰ã€‚

```mermaid
sequenceDiagram
participant T as Teacher
participant W as Web
participant A as API (Availability)
participant D as DB
participant C as Cache
T->>W: å½•å…¥/ç¼–è¾‘åŒºé—´
W->>A: POST /api/teachers/{id}/availability
A->>D: å†™å…¥æˆ–æ›´æ–° availability
A->>C: å¤±æ•ˆ slots ç¼“å­˜ (å—å½±å“æ—¥æœŸèŒƒå›´)
A-->>W: 200 OK
```

## 3.8 æ•™å¸ˆï½œç»´æŠ¤é˜»å¡æ—¶é—´

**ç›®æ ‡**ï¼šè®°å½•ä¸€æ®µä¸å¯é¢„çº¦æ—¶é—´ï¼ˆä¸Šè¯¾/å¼€ä¼š/ä¼‘å‡ç­‰ï¼‰ã€‚

**å…³é”®è§„åˆ™**ï¼šä¸é¢„çº¦å†²çªæ—¶æç¤ºé£é™©ï¼ˆéœ€äººå·¥æ²Ÿé€šï¼‰ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒæ—¶é—´èŒƒå›´ä¸æœ€å°ç²’åº¦ï¼›
2. å†™å…¥ `blocked_times`ï¼›
3. è‹¥ä¸æ—¢æœ‰é¢„çº¦é‡å ï¼Œè¿”å›å‘Šè­¦å­—æ®µä¾›å‰ç«¯æç¤ºï¼›
4. å¤±æ•ˆç›¸å…³æ—¥æœŸçš„æ§½ä½ç¼“å­˜ã€‚

```mermaid
sequenceDiagram
participant T as Teacher
participant W as Web
participant A as API (Blocked)
participant D as DB
participant C as Cache
T->>W: é€‰æ‹©èµ·æ­¢æ—¶é—´ä¸åŸå› 
W->>A: POST /api/blocked-times
A->>D: å†™å…¥ blocked_times
A->>C: å¤±æ•ˆ slots ç¼“å­˜
A-->>W: 200 OK (å¦‚ä¸æ—¢æœ‰é¢„çº¦é‡å â†’å‰ç«¯æç¤ºé£é™©)
```

## 3.9 æ•™å¸ˆï½œå®¡æ‰¹/æ‹’ç»é¢„çº¦

**ç›®æ ‡**ï¼šå¯¹ `pending` æ‰§è¡Œ `approve|cancel`ã€‚

**å…³é”®è§„åˆ™**ï¼šè®°å½•åŸå› /æ—¶é—´ï¼›é€šçŸ¥ã€‚

**æ­¥éª¤**ï¼š

1. æ ¡éªŒæ“ä½œè€…ä¸ºè¯¥æ•™å¸ˆï¼›
2. è‹¥çŠ¶æ€é `pending` â†’ `STATE_CONFLICT`ï¼›
3. æŒ‰åŠ¨ä½œæ›´æ–°çŠ¶æ€å¹¶è®°å½•å®¡è®¡ï¼›
4. å‘é€ç»“æœé€šçŸ¥ã€‚

```mermaid
sequenceDiagram
participant T as Teacher
participant W as Web
participant A as API (Appointments)
participant D as DB
participant E as Email
T->>W: åœ¨å¾…åŠç‚¹å‡» é€šè¿‡/æ‹’ç»
W->>A: PATCH /api/appointments/{id} {action}
A->>D: æ ¡éªŒå½“å‰çŠ¶æ€= pending & èµ„æºå½’å±
alt é€šè¿‡
A->>D: æ›´æ–°ä¸º approved, å†™ approvedAt
else æ‹’ç»
A->>D: æ›´æ–°ä¸º cancelled, å†™ reason
end
A->>E: é€šçŸ¥å­¦ç”Ÿ
A-->>W: 200 OK
```

## 3.10 ç®¡ç†ï½œæœåŠ¡çº§åˆ«ç­–ç•¥

**ç›®æ ‡**ï¼šå‚æ•°åŒ–é…é¢é˜ˆå€¼ã€è¶…æ—¶é˜ˆå€¼ã€æé†’ç­–ç•¥ç­‰ï¼ˆä¸ºåç»­ç­–ç•¥è¡¨åšå‡†å¤‡ï¼‰ã€‚

**æ­¥éª¤**ï¼š

1. å®šä¹‰ç­–ç•¥è¡¨ï¼ˆå¯å«ç§Ÿæˆ·ç»´åº¦ï¼‰ï¼›
2. ä¸šåŠ¡è¯»å–ç­–ç•¥æ—¶åŠ å…¥ç¼“å­˜ï¼›
3. æ›´æ–°ç­–ç•¥æ—¶å¹¿æ’­/åˆ·æ–°ç›¸å…³ç¼“å­˜é”®ã€‚

```mermaid
sequenceDiagram
participant M as Admin
participant W as Web(Admin)
participant A as API (Policy)
participant D as DB
M->>W: ä¿®æ”¹ç­–ç•¥å‚æ•°
W->>A: PUT /api/policies {quota,expireHours,remindOffsets}
A->>D: Upsert ç­–ç•¥è¡¨
A-->>W: 200 OK
```

## 3.11 ç³»ç»Ÿï½œ48h å¾…å®¡æ‰¹è¿‡æœŸ

**ç›®æ ‡**ï¼šå®šæ—¶æ‰«æ `pending` è¶…æ—¶â†’`expired` å¹¶é€šçŸ¥ã€‚

**æ­¥éª¤**ï¼š

1. Cron å®šæ—¶è§¦å‘ï¼›
2. åˆ†é¡µæ‰¹å¤„ç†ï¼Œé¿å…å¤§äº‹åŠ¡ï¼›
3. è®°å½•å®¡è®¡ä¸å¤±è´¥é‡è¯•ç»Ÿè®¡ï¼›
4. å¯é€‰ï¼šå°†é€šçŸ¥æ¨å…¥é˜Ÿåˆ—å¼‚æ­¥å‘é€ã€‚

```mermaid
sequenceDiagram
participant Q as Cron
participant A as Job API
participant D as DB
participant E as Email
Q->>A: POST /api/jobs/expire-pending
A->>D: æŸ¥ pending where createdAt < now-48h
A->>D: æ‰¹é‡æ›´æ–°ä¸º expired
A->>E: å‘é€è¿‡æœŸé€šçŸ¥ï¼ˆå­¦ç”Ÿ+æ•™å¸ˆï¼‰
```

## 3.12 ç³»ç»Ÿï½œæœˆåˆé…é¢é‡ç½®

**å®ç°è¯´æ˜ï¼ˆä¸ä»£ç ä¸€è‡´ï¼‰**ï¼š

- è·¯ç”±ï¼š`POST /api/jobs/reset-quota`ï¼ˆå®ç°æ–‡ä»¶ï¼š`src/app/api/jobs/reset-quota/route.ts`ï¼‰ã€‚
- é‰´æƒï¼šå¿…é¡»æä¾›è§¦å‘å¯†é’¥ï¼Œåç«¯ä¼šæ£€æŸ¥ header `x-job-secret` æˆ– `Authorization: Bearer <secret>`ï¼Œè¯¥å¯†é’¥åœ¨éƒ¨ç½²ç¯å¢ƒä¸­ç”± `JOB_TRIGGER_SECRET` ç¯å¢ƒå˜é‡é…ç½®ã€‚æœªæˆæƒè¯·æ±‚è¿”å› 401ã€‚
- è§¦å‘æ—¶æœºé™åˆ¶ï¼šé»˜è®¤åªå…è®¸åœ¨æ¯æœˆç¬¬ 1 æ—¥æ‰§è¡Œï¼›å¯¹äºæµ‹è¯•æˆ–æ‰‹åŠ¨è§¦å‘ï¼Œå¯ä»¥ä½¿ç”¨ `?force=true` å¼ºåˆ¶è¿è¡Œï¼ˆè·¯ç”±ä¼šæ¥å—è¯¥å‚æ•°å¹¶è·³è¿‡æ—¥æœŸé™åˆ¶ï¼‰ã€‚
- è¡Œä¸ºï¼šæŸ¥æ‰¾ `lastQuotaReset` æ—©äºæœ¬æœˆæœˆåˆçš„å­¦ç”Ÿï¼Œæ‰¹é‡å°† `monthlyMeetingsUsed` ç½®ä¸º `0`ï¼Œå¹¶æŠŠ `lastQuotaReset` æ›´æ–°ä¸ºæœ¬æœˆæœˆåˆï¼ˆ`new Date(year, month, 1)`ï¼‰ã€‚
- å®¡è®¡ï¼šä¼šå†™å…¥ä¸€æ¡ `AuditLog`ï¼ˆaction=`QUOTA_RESET`ï¼‰ï¼ŒåŒ…å«æœ¬æ¬¡è¢«é‡ç½®çš„å­¦ç”Ÿ idã€æ­¤å‰é…é¢ç­‰ä¿¡æ¯ã€‚
- å¹‚ç­‰æ€§ï¼šè¯¥ä»»åŠ¡æŒ‰æœˆè®¾è®¡ä¸ºå¹‚ç­‰â€”â€”åŒä¸€æœˆé‡å¤è¿è¡Œä¸ä¼šå†é‡ç½®å·²æ›´æ–°çš„å­¦ç”Ÿï¼ˆæŸ¥è¯¢æ¡ä»¶ä¸º `lastQuotaReset < æœ¬æœˆæœˆåˆ`ï¼‰ã€‚

```mermaid
sequenceDiagram
participant Q as Cron
participant A as Job API
participant D as DB
Q->>A: POST /api/jobs/reset-quota (é€šå¸¸æ¯æœˆ1æ—¥ 00:05)
A->>D: SELECT students WHERE lastQuotaReset < æœ¬æœˆæœˆåˆ
A->>D: UPDATE æ¯ä¸ª student SET monthlyMeetingsUsed=0, lastQuotaReset=æœ¬æœˆæœˆåˆ
D-->>A: è¿”å›å½±å“è¡Œæ•°

```

### åœ¨ Vercel ä¸Šéƒ¨ç½²ä¸å®šæ—¶è§¦å‘

å¦‚æœä½ çš„åº”ç”¨éƒ¨ç½²åœ¨ Vercelï¼Œå¯ä»¥ä½¿ç”¨ Vercel çš„ Scheduled Functionsï¼ˆCron Jobsï¼‰æ¥è§¦å‘è¯¥æ¥å£ï¼š

è¯´æ˜ï¼šæŒ‰ä½ æä¾›çš„ä¿¡æ¯ï¼Œå®šæ—¶ä»»åŠ¡å·²é€šè¿‡ `vercel.json` é…ç½®ï¼ˆå‚è€ƒ https://vercel.com/docs/cron-jobsï¼‰ï¼Œä¸” `JOB_TRIGGER_SECRET` å·²åœ¨ Vercel çš„ Environment Variables ä¸­é…ç½®ã€‚

å¦‚æœä½ å¸Œæœ›æŠŠé…ç½®å†™å…¥ä»“åº“ï¼ˆå¯è¢« Vercel è¯»å–ï¼‰ï¼Œç¤ºä¾‹ `vercel.json` çš„ Cron é…ç½®ç‰‡æ®µå¦‚ä¸‹ï¼š

```json
{
  "crons": [{ "path": "/api/jobs/reset-quota", "schedule": "5 0 1 * *" }]
}
```

æ³¨æ„ï¼šä¸è¦æŠŠ `JOB_TRIGGER_SECRET` å†™å…¥ä»“åº“ï¼›è¯¥å¯†é’¥åº”é€šè¿‡ Vercel Dashboard -> Project -> Settings -> Environment Variables æ·»åŠ åˆ° Productionï¼ˆæˆ–å¯¹åº”ç¯å¢ƒï¼‰ã€‚åç«¯åŒæ—¶æ¥å— `Authorization: Bearer <secret>` æˆ– `x-job-secret: <secret>` ä¸¤ç§ header å½¢å¼ã€‚

éªŒè¯æ–¹æ³•ï¼ˆå¯é€æ­¥æ‰§è¡Œï¼‰ï¼š

1. åœ¨ Vercel Dashboard â†’ Project â†’ Functions / Cronï¼ˆæˆ– Scheduled Jobsï¼‰ç¡®è®¤å­˜åœ¨ä¸€æ¡è·¯å¾„ä¸º `/api/jobs/reset-quota` çš„ Cron ä»»åŠ¡å¹¶å¤„äºå¯ç”¨çŠ¶æ€ã€‚
2. åœ¨ Vercel çš„ Function Logs ä¸­æŸ¥çœ‹æœ€è¿‘çš„ Cron æ‰§è¡Œè®°å½•ï¼ˆæˆ–æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å¹¶è§‚å¯Ÿæ—¥å¿—ï¼‰ï¼Œç¡®è®¤è¯·æ±‚çš„ HTTP çŠ¶æ€ç ä¸è¿”å›ä½“ã€‚
3. æ‰‹åŠ¨è§¦å‘ï¼ˆæµ‹è¯•ç”¨ï¼Œä½¿ç”¨ä½ åœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­é…ç½®çš„ secretï¼‰ï¼š

```bash
BASE_URL="https://your-deployment.vercel.app"
JOB_TRIGGER_SECRET="<your-secret-from-vercel>"
curl -i -X POST "$BASE_URL/api/jobs/reset-quota?force=true" \
  -H "Authorization: Bearer $JOB_TRIGGER_SECRET"
```

4. éªŒè¯æ•°æ®åº“å®¡è®¡ï¼šæŸ¥è¯¢ `audit_logs` è¡¨ï¼Œç¡®è®¤æœ€è¿‘æœ‰ `action='QUOTA_RESET'` çš„è®°å½•ï¼Œä¾‹å¦‚ï¼š

```sql
SELECT id, action, details, created_at
FROM audit_logs
WHERE action = 'QUOTA_RESET'
ORDER BY created_at DESC
LIMIT 5;
```

å¦‚æœéœ€è¦ï¼Œæˆ‘å¯ä»¥ï¼š

- å¸®ä½ æŠŠ `vercel.json` ä¸­çš„ Cron ç‰‡æ®µåŠ å…¥ä»“åº“ï¼ˆç¤ºä¾‹ï¼Œä¸ä¼šåŒ…å« secretï¼‰ï¼Œæˆ–
- æŠŠ README ä¸­çš„è¯¥æ®µè½æ”¹ä¸ºè¯´æ˜ä½ å·²ç»åœ¨ `vercel.json` ä¸­æ·»åŠ äº† Cronï¼ˆå½“å‰å·²å®Œæˆï¼‰ã€‚



## 3.13 ç³»ç»Ÿï½œæé†’é€šçŸ¥

**ç›®æ ‡**ï¼šT-24h / T-1h æé†’å­¦ç”Ÿä¸æ•™å¸ˆã€‚

**æ­¥éª¤**ï¼š

1. è®¡ç®—æ—¶é—´çª—å£ï¼ˆUTCï¼‰ï¼›
2. é˜²é‡ï¼šå¯¹åŒä¸€é¢„çº¦åŒä¸€æé†’ç±»å‹è®¾ç½®æŒ‡çº¹å»é‡ï¼›
3. å¤±è´¥é‡è¯•ä¸é€€é¿

```mermaid
sequenceDiagram
participant Q as Cron/Queue
participant A as Job API
participant D as DB
participant E as Email
Q->>A: è§¦å‘ remind-24h / remind-1h
A->>D: æŸ¥ approved ä¸” scheduledTime in çª—å£
A->>E: æ‰¹é‡å‘é€æé†’ï¼ˆå«å–æ¶ˆé“¾æ¥ï¼‰
````

## 3.14 ç³»ç»Ÿï½œå€™è¡¥é˜Ÿåˆ—

**ç›®æ ‡**ï¼šçƒ­é—¨æ—¶æ®µè¢«å æ—¶å¯åŠ å…¥å€™è¡¥ï¼Œé‡Šæ”¾æ—¶è‡ªåŠ¨é¡¶æ›¿ï¼ˆå¹¶é€šçŸ¥ç›¸å…³äººï¼‰ã€‚

**æ•°æ®ç»“æ„ä¸çº¦æŸï¼ˆå®é™…å®ç°ï¼‰**ï¼š
- è¡¨ `waitlists`ï¼ˆPrisma æ¨¡å‹ `Waitlist`ï¼‰ï¼š`teacherId,date,slot,studentId,status,priority,idempotencyKey,notifiedAt,promotedAt,expiresAt,createdAt,updatedAt`ã€‚
- å¤åˆå”¯ä¸€çº¦æŸï¼šåŒä¸€ `teacherId+slot+studentId` åªèƒ½æ’é˜Ÿä¸€æ¬¡ï¼ˆé˜²é‡å¤ï¼‰ã€‚
- `status`ï¼š`active | promoted | cancelled | expired`ï¼ˆå½“å‰ä¸»è¦ä½¿ç”¨ active/expiredï¼Œpromoted ç”±å®¡è®¡æ—¥å¿—ä½“ç°ï¼‰ã€‚
- é€‰å–è§„åˆ™ï¼šæŒ‰ `createdAt` å…ˆåï¼ˆFIFOï¼‰ã€‚UI ä¸­ä¼šæ˜¾ç¤ºåŸºäºæœåŠ¡çº§åˆ«æ˜ å°„çš„â€œå±•ç¤ºä¼˜å…ˆçº§â€ï¼Œä½†æ™‹å‡æ—¶ä¸å‚ä¸æ’åºã€‚

**æ¥å£ä¸ä½œä¸šï¼ˆèŠ‚é€‰ï¼‰**ï¼š
- å­¦ç”ŸåŠ å…¥/ç§»é™¤/æŸ¥è¯¢ï¼š
  - POST `/api/waitlist`ï¼ˆéœ€ body: teacherId, date, slot, studentId, subjectï¼‰
  - DELETE `/api/waitlist`ï¼ˆbody: id, studentIdï¼‰
  - GET `/api/waitlist?studentId=...|teacherId=...`
  - GET `/api/waitlist/slot?teacherId=...&slot=...&studentId=...`ï¼ˆæ§½ä½é˜Ÿåˆ—è¯¦æƒ… + æˆ‘çš„æ’ä½ï¼‰
- æ™‹å‡ï¼š
  - ç³»ç»Ÿå†…éƒ¨ï¼šPOST `/api/waitlist/promote`ï¼ˆä»…ä½œä¸šé‰´æƒè°ƒç”¨ï¼‰ï¼Œæˆ–ç”±å–æ¶ˆé¢„çº¦åç›´æ¥åœ¨äº‹åŠ¡ä¸­è°ƒç”¨æ™‹å‡ helperã€‚
- å®šæ—¶ä»»åŠ¡ï¼ˆVercel Cronï¼‰ï¼š
  - `/api/jobs/cleanup-waitlist`ï¼ˆæ¯æ—¥æ¸…ç†å·²è¢«å ç”¨æ§½ä½ä¸Šçš„æ®‹ç•™å€™è¡¥ï¼‰
  - `/api/jobs/expire-waitlist`ï¼ˆæ¯ 10 åˆ†é’Ÿæ ‡è®°å·²è¿‡æœŸçš„ active å€™è¡¥ä¸º expired å¹¶é€šçŸ¥ï¼‰

**å·¥ä½œæµè¯´æ˜**ï¼š
- åŠ å…¥å€™è¡¥ï¼šæŸ¥é‡ â†’ å†™å…¥ waitlists â†’ å†™å®¡è®¡ï¼ˆWAITLIST_ADDEDï¼‰â†’ è¿”å›å½“å‰æ’ä½ã€‚
- æ§½ä½é‡Šæ”¾è‡ªåŠ¨æ™‹å‡ï¼šå½“é¢„çº¦è¢«å–æ¶ˆæ—¶è§¦å‘ï¼›åœ¨æ•°æ®åº“äº‹åŠ¡ä¸­å¹¶å‘å®‰å…¨åœ°é€‰æ‹©æœ€æ—©å€™è¡¥å¹¶åˆ›å»º/æ›´æ–°é¢„çº¦ï¼ˆè‹¥ Premium æˆ–åœ¨è‡ªåŠ¨æ‰¹å‡†é¢åº¦å†…å¯ç›´æ¥æ‰¹å‡†ï¼‰ï¼Œåˆ é™¤å€™è¡¥é‡å¤é¡¹å¹¶å†™å®¡è®¡ï¼ˆWAITLIST_PROMOTEDï¼‰ï¼Œéšåå‘é€é€šçŸ¥ã€‚
- å®šæœŸæ¸…ç†ä¸è¿‡æœŸï¼šå·²è¢«å ç”¨çš„æ§½ä½æ¸…ç†å€™è¡¥æ®‹ç•™ï¼›slot å·²è¿‡æœŸçš„ active å€™è¡¥æ ‡è®°ä¸º expired å¹¶é€šçŸ¥å­¦ç”Ÿï¼ˆWAITLIST_EXPIREDï¼‰ã€‚

```mermaid
sequenceDiagram
  autonumber
  actor Student
  participant UI as Frontend (StudentBookingCalendar)
  participant API as API Server (Next.js)
  participant DB as Prisma / DB
  participant Promo as promoteForSlotTx
  participant Email as Email Service
  participant CronCleanup as Cron: cleanup-waitlist
  participant CronExpire as Cron: expire-waitlist

  rect rgb(245,245,245)
  note over Student,API: 1) å­¦ç”ŸåŠ å…¥å€™è¡¥
  Student->>UI: ç‚¹â€œåŠ å…¥å€™è¡¥â€
  UI->>API: POST /api/waitlist {teacherId,date,slot,studentId,subject}
  API->>DB: waitlist.findFirst(æŸ¥é‡)
  alt å·²å­˜åœ¨
    API-->>UI: 409 Duplicate
  else ä¸å­˜åœ¨
    API->>DB: waitlist.create()
    API->>DB: auditLog.create(WAITLIST_ADDED)
    API-->>UI: 201 {id, position}
  end
  end

  rect rgb(245,245,245)
  note over UI,Email: 2) é¢„çº¦å–æ¶ˆ â†’ è‡ªåŠ¨æ™‹å‡
  UI->>API: PATCH /api/appointments/:id {action: cancel}
  API->>DB: appointment.update(status=cancelled)

  par ç›´æ¥äº‹åŠ¡æ™‹å‡
    API->>Promo: tx promoteForSlotTx(teacherId, slot, subject)
    alt æ™‹å‡æˆåŠŸ
      Promo->>DB: SELECT ... FOR UPDATE SKIP LOCKED (å–æœ€æ—©å€™é€‰)
      Promo->>DB: æ£€æŸ¥è¯¥æ§½ä½æ˜¯å¦å ç”¨(pending/approved)
      Promo->>DB: é…é¢/ç­–ç•¥æ ¡éªŒ(ServicePolicyã€serviceLevel)
      Promo->>DB: create/update appointment
      Promo->>DB: delete waitlist (+ åŒå­¦è¯¥sloté‡å¤é¡¹)
      Promo->>DB: student.monthlyMeetingsUsed += 1
      Promo->>DB: auditLog.create(WAITLIST_PROMOTED)
      Promo-->>API: {promoted:1, appointmentId, status}
      API->>DB: æ¸…ç† slots ç¼“å­˜
      API->>Email: å‘é€ pending/approved å¯¹åº”é€šçŸ¥
    else æ— å€™é€‰
      Promo-->>API: {promoted:0}
    end
  and HTTP å†—ä½™è§¦å‘
    API->>API: POST /api/waitlist/promote (job-auth)
  end
  end

  rect rgb(245,245,245)
  note over CronCleanup,API: 3) å®šæ—¶æ¸…ç†å ç”¨æ§½ä½çš„å€™è¡¥
  CronCleanup->>API: POST /api/jobs/cleanup-waitlist
  API->>DB: åˆ—å‡ºè‹¥å¹²(teacherId,slot)å¯¹
  loop each pair
    API->>DB: ç»Ÿè®¡è¯¥slotçš„é¢„çº¦(pending/approved)
    alt å·²å ç”¨
      API->>DB: waitlist.deleteMany(è¯¥slot)
    end
  end
  API-->>CronCleanup: {checked, removed}
  end

  rect rgb(245,245,245)
  note over CronExpire,Email: 4) å®šæ—¶è¿‡æœŸå€™è¡¥å¹¶é€šçŸ¥
  CronExpire->>API: POST /api/jobs/expire-waitlist
  API->>DB: waitlist.findMany(status='active', slot<now)
  loop each item
    API->>DB: waitlist.update(status='expired', expiresAt=now)
    API->>DB: auditLog.create(WAITLIST_EXPIRED)
    API->>Email: å‘é€è¿‡æœŸé€šçŸ¥
  end
  API-->>CronExpire: {updated, results}
  end

  rect rgb(245,245,245)
  note over UI,API: 5) å‰ç«¯æŸ¥çœ‹æ§½ä½ä¸å€™è¡¥è¯¦æƒ…
  UI->>API: GET /api/slots?teacherId&date
  API->>DB: æŸ¥é¢„çº¦ + å€™è¡¥è®¡æ•°
  API-->>UI: {slots, bookedSlots, waitlistCount}

  UI->>API: GET /api/waitlist/slot?teacherId&slot&studentId
  API->>DB: æŒ‰createdAtå‡åºå–é˜Ÿåˆ—
  API-->>UI: {total, waitlist, myPosition}
  end
```

# å››ã€æ•°æ®åº“è®¾è®¡

## 4.1 usersï¼ˆç»Ÿä¸€èº«ä»½è¡¨ï¼‰

| å­—æ®µå        | ç±»å‹            | çº¦æŸ                     | è¯´æ˜                               |
| ------------- | --------------- | ------------------------ | ---------------------------------- |
| id            | UUID            | PK                       | ç»Ÿä¸€ç”¨æˆ· ID                        |
| email         | VARCHAR(255)    | UNIQUE, NOT NULL         | ç™»å½•é‚®ç®±                           |
| password_hash | VARCHAR(255)    | NOT NULL                 | å¯†ç å“ˆå¸Œï¼ˆArgon2id / bcryptâ‰¥10ï¼‰   |
| role          | String          | NOT NULL                 | è§’è‰²ï¼šstudent/teacher/admin        |
| status        | String          | NOT NULL DEFAULT 'pending' | è´¦æˆ·çŠ¶æ€ï¼ˆpending/active/...ï¼‰   |
| name          | String          | NOT NULL                 | æ˜¾ç¤ºåç§°                           |
| is_active     | Boolean         | DEFAULT true             | æ˜¯å¦å¯ç”¨                           |
| created_at    | TIMESTAMPTZ     | DEFAULT NOW()            |                                    |
| updated_at    | TIMESTAMPTZ     | DEFAULT NOW()            |                                    |

## 4.2 studentsï¼ˆå­¦ç”Ÿæ‰©å±•è¡¨ï¼‰

| å­—æ®µå                | ç±»å‹                              | çº¦æŸ                             | è¯´æ˜              |
| --------------------- | --------------------------------- | -------------------------------- | ----------------- |
| id                    | UUID                              | PK                               |                   |
| user_id               | UUID                              | FK â†’ users(id), UNIQUE, NOT NULL | ä¸ users 1:1 ç»‘å®š |
| service_level         | ENUM('level1','level2','premium') | NOT NULL                         | æœåŠ¡çº§åˆ«          |
| monthly_meetings_used | INT                               | DEFAULT 0                        | å½“æœˆå·²ç”¨é…é¢      |
| last_quota_reset      | TIMESTAMPTZ                       | DEFAULT NOW()                    | ä¸Šæ¬¡é…é¢é‡ç½®æ—¶é—´  |
| grade_level           | INT                               |                                  | å¹´çº§              |
| created_at            | TIMESTAMPTZ                       | DEFAULT NOW()                    |                   |
| updated_at            | TIMESTAMPTZ                       | DEFAULT NOW()                    |                   |

è¯´æ˜ï¼šå­¦ç”Ÿæ‰€ä¿®ç§‘ç›®é€šè¿‡å…³è”è¡¨ `student_subjects` ç»´æŠ¤ï¼ˆè§ 4.5ï¼‰ã€‚

## 4.3 teachersï¼ˆæ•™å¸ˆè¡¨ï¼‰

| å­—æ®µå             | ç±»å‹        | çº¦æŸ                             | è¯´æ˜                                |
| ------------------ | ----------- | -------------------------------- | ----------------------------------- |
| id                 | UUID        | PK                               |                                     |
| user_id            | UUID        | FK â†’ users(id), UNIQUE, NOT NULL | ä¸ users 1:1 ç»‘å®š                   |
| max_daily_meetings | INT         | DEFAULT 8                        | æ¯æ—¥ä¸Šé™                            |
| buffer_minutes     | INT         | DEFAULT 15                       | ä¼šè®®ç¼“å†²åˆ†é’Ÿ                        |
| timezone           | VARCHAR(64) | NOT NULL DEFAULT 'Asia/Shanghai' | æ•™å¸ˆæ‰€åœ¨æ—¶åŒº                        |
| created_at         | TIMESTAMPTZ | DEFAULT NOW()                    |                                     |
| updated_at         | TIMESTAMPTZ | DEFAULT NOW()                    |                                     |

è¯´æ˜ï¼šæ•™å¸ˆå¯æˆç§‘ç›®é€šè¿‡å…³è”è¡¨ `teacher_subjects` ç»´æŠ¤ï¼ˆè§ 4.6ï¼‰ã€‚

## 4.4 subjectsï¼ˆç§‘ç›®è¡¨ï¼‰

| å­—æ®µå     | ç±»å‹          | çº¦æŸ               | è¯´æ˜         |
| ---------- | ------------- | ------------------ | ------------ |
| id         | UUID          | PK                 |              |
| name       | VARCHAR(100)  | UNIQUE, NOT NULL   | ç§‘ç›®åç§°     |
| code       | VARCHAR(100)  | UNIQUE, NOT NULL   | å”¯ä¸€ç¼–ç      |
| description| TEXT          |                    | æè¿°         |
| is_active  | BOOLEAN       | DEFAULT true       | å¯ç”¨çŠ¶æ€     |
| created_at | TIMESTAMPTZ   | DEFAULT NOW()      |              |
| updated_at | TIMESTAMPTZ   | DEFAULT NOW()      |              |

## 4.5 student_subjectsï¼ˆå­¦ç”Ÿ-ç§‘ç›® å…³è”è¡¨ï¼‰

| å­—æ®µå     | ç±»å‹ | çº¦æŸ                                   | è¯´æ˜         |
| ---------- | ---- | -------------------------------------- | ------------ |
| id         | UUID | PK                                     |              |
| student_id | UUID | FK â†’ students(id)                      | å­¦ç”Ÿ         |
| subject_id | UUID | FK â†’ subjects(id)                      | ç§‘ç›®         |
| UNIQUE     |      | (student_id, subject_id)               | é˜²é‡å¤       |

## 4.6 teacher_subjectsï¼ˆæ•™å¸ˆ-ç§‘ç›® å…³è”è¡¨ï¼‰

| å­—æ®µå     | ç±»å‹ | çº¦æŸ                                   | è¯´æ˜         |
| ---------- | ---- | -------------------------------------- | ------------ |
| id         | UUID | PK                                     |              |
| teacher_id | UUID | FK â†’ teachers(id)                      | æ•™å¸ˆ         |
| subject_id | UUID | FK â†’ subjects(id)                      | ç§‘ç›®         |
| UNIQUE     |      | (teacher_id, subject_id)               | é˜²é‡å¤       |
| created_at | TIMESTAMPTZ | DEFAULT NOW()                    |                            |

## 4.5 teacher_availabilityï¼ˆæ•™å¸ˆå¯ç”¨æ€§ï¼‰

| å­—æ®µå       | ç±»å‹    | çº¦æŸ                        | è¯´æ˜         |
| ------------ | ------- | --------------------------- | ------------ |
| id           | UUID    | PK                          |              |
| teacher_id   | UUID    | FK â†’ teachers(id), NOT NULL | æ•™å¸ˆ         |
| day_of_week  | INT     | 0â€“6                         | å‘¨æ—¥=0       |
| start_time   | TIME    | NOT NULL                    |              |
| end_time     | TIME    | NOT NULL                    |              |
| is_recurring | BOOLEAN | DEFAULT true                | æ˜¯å¦æ¯å‘¨é‡å¤ |
| is_active    | BOOLEAN | DEFAULT true                | æ˜¯å¦å¯ç”¨     |

## 4.6 blocked_timesï¼ˆé˜»å¡æ—¶æ®µï¼‰

| å­—æ®µå     | ç±»å‹         | çº¦æŸ              | è¯´æ˜ |
| ---------- | ------------ | ----------------- | ---- |
| id         | UUID         | PK                |      |
| teacher_id | UUID         | FK â†’ teachers(id) | æ•™å¸ˆ |
| start_time | TIMESTAMPTZ  | NOT NULL          |      |
| end_time   | TIMESTAMPTZ  | NOT NULL          |      |
| reason     | VARCHAR(255) |                   | åŸå›  |
| created_at | TIMESTAMPTZ  | DEFAULT NOW()     |      |

## 4.7 appointmentsï¼ˆé¢„çº¦è¡¨ï¼‰

| å­—æ®µå            | ç±»å‹                                                                   | çº¦æŸ                                     | è¯´æ˜            |
| ----------------- | ---------------------------------------------------------------------- | ---------------------------------------- | --------------- |
| id                | UUID                                                                   | PK                                       |                 |
| student_id        | UUID                                                                   | FK â†’ students(id)                        | å­¦ç”Ÿ            |
| teacher_id        | UUID                                                                   | FK â†’ teachers(id)                        | æ•™å¸ˆ            |
| subject_id        | UUID                                                                   | FK â†’ subjects(id)                        | ç§‘ç›®            |
| scheduled_time    | TIMESTAMPTZ                                                            | NOT NULL                                 | å¼€å§‹æ—¶é—´ï¼ˆUTCï¼‰ |
| duration_minutes  | INT                                                                    | DEFAULT 30                               | æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰    |
| status            | ENUM('pending','approved','completed','cancelled','no_show','expired') | NOT NULL                                 | ç»Ÿä¸€çŠ¶æ€æšä¸¾    |
| approval_required | BOOLEAN                                                                | NOT NULL                                 | æ˜¯å¦éœ€å®¡æ‰¹      |
| approved_at       | TIMESTAMPTZ                                                            |                                          | å®¡æ‰¹æ—¶é—´        |
| idempotency_key   | VARCHAR(128)                                                           | UNIQUE                                   | å¹‚ç­‰é”®          |
| created_at        | TIMESTAMPTZ                                                            | DEFAULT NOW()                            |                 |
| updated_at        | TIMESTAMPTZ                                                            | DEFAULT NOW()                            |                 |
| å”¯ä¸€ç´¢å¼•          |                                                                        | (teacher_id, scheduled_time)             | é˜²æ­¢é‡å åˆ›å»º    |

å¤‡æ³¨ï¼šå®é™…å®ç°é‡‡ç”¨æ™®é€šå”¯ä¸€ç´¢å¼• `(teacher_id, scheduled_time)`ï¼Œæœªå¯ç”¨ `TSTZRANGE + GIST` æ’ä»–çº¦æŸã€‚

## 4.8 æœåŠ¡çº§åˆ«ç­–ç•¥è¡¨ï¼ˆservice_policiesï¼‰

| å­—æ®µå            | ç±»å‹   | çº¦æŸ/é»˜è®¤         | è¯´æ˜                                   |
| ----------------- | ------ | ---------------- | -------------------------------------- |
| id                | UUID   | PK               |                                         |
| level             | String | UNIQUE           | æœåŠ¡çº§åˆ«ï¼ˆlevel1/level2/premiumï¼‰      |
| monthlyAutoApprove| Int    | DEFAULT 0        | å½“æœˆè‡ªåŠ¨æ‰¹å‡†é…é¢ï¼ˆæ ¡éªŒä¸è·¯ç”±ä½¿ç”¨ï¼‰     |
| priority          | Bool   | DEFAULT false    | æ˜¯å¦ä¼˜å…ˆï¼ˆå±•ç¤ºç”¨ï¼‰                     |
| expireHours       | Int    | DEFAULT 48       | å¾…å®¡æ‰¹è¿‡æœŸæ—¶é•¿ï¼ˆå°æ—¶ï¼‰                 |
| reminderOffsets   | String | DEFAULT '24,1'   | æé†’åç§»ï¼ˆé€—å·åˆ†éš”ï¼Œä¾‹å¦‚ 24,1 å°æ—¶ï¼‰   |
| created_at        | TIMESTAMPTZ | DEFAULT NOW() |                                         |
| updated_at        | TIMESTAMPTZ | DEFAULT NOW() |                                         |

## 4.9 å®¡è®¡æ—¥å¿—è¡¨ï¼ˆaudit_logsï¼‰

| å­—æ®µå     | ç±»å‹     | æè¿°        |
| ---------- | -------- | ----------- |
| id         | UUID     | æ—¥å¿— ID     |
| actor_id   | UUID     | æ“ä½œè€… ID   |
| action     | String   | åŠ¨ä½œåç§°    |
| target_id  | UUID     | ç›®æ ‡å¯¹è±¡ ID |
| details    | TEXT     | è¯¦æƒ… JSON   |
| ip_address | TEXT     | æ¥æº IP     |
| user_agent | TEXT     | UA          |
| created_at | DateTime | æ“ä½œæ—¶é—´    |

# äº”ã€æ¥å£è®¾è®¡

## 5.1 å­¦ç”Ÿç«¯æ¥å£ï¼ˆStudent APIsï¼‰

> é‰´æƒï¼šBearer JWTï¼ˆrole=studentï¼‰ã€‚æ—¶åŒºï¼šæ‰€æœ‰æ—¶é—´å­—æ®µå‡ä¸º ISO8601 UTCã€‚

### 5.1.1 æŸ¥è¯¢æ•™å¸ˆå¯ç”¨æ§½ä½

- GET `/api/slots?teacherId={id}&date=YYYY-MM-DD&duration=30&excludeUserId={userId}`
- è¯´æ˜ï¼š`date` å‚æ•°æŒ‰æ•™å¸ˆæ—¶åŒºè§£é‡Šï¼Œåç«¯æ¢ç®—ä¸º UTCï¼›`excludeUserId` å¯é€‰ï¼Œç”¨äºä»â€œå·²é¢„çº¦ç»Ÿè®¡â€ä¸­æ’é™¤å½“å‰ç”¨æˆ·ï¼ˆé¿å…è¯¯åˆ¤å¯ç”¨æ€§ï¼‰ã€‚
- è¯·æ±‚å‚æ•°ï¼š
  - `teacherId` _(required)_ï¼šæ•™å¸ˆ ID
  - `date` _(required)_ï¼šæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
  - `duration` _(optional, default=30)_ï¼šä¼šè®®æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  - `excludeUserId` _(optional)_ï¼šæ’é™¤è¯¥ç”¨æˆ·çš„é¢„çº¦ï¼ˆé€šè¿‡å­¦ç”Ÿ userIdï¼‰
- å“åº” 200ï¼š

```json
{
  "teacherId": "t_123",
  "date": "2025-08-22",
  "duration": 30,
  "slots": ["2025-08-22T01:00:00Z", "2025-08-22T01:30:00Z"],
  "bookedSlots": ["2025-08-22T02:00:00Z"],
  "waitlistCount": [
    { "slot": "2025-08-22T01:00:00Z", "count": 2 }
  ]
}
```

- é”™è¯¯ï¼š`BAD_REQUEST`ã€`TEACHER_NOT_FOUND`ã€‚

### 5.1.2 åˆ›å»ºé¢„çº¦

- **POST** `/api/appointments`
- **è¯´æ˜**ï¼šæ ¹æ®æœåŠ¡çº§åˆ«è‡ªåŠ¨è·¯ç”±åˆ° `approved`/`pending`ï¼Œå¸¦å¹‚ç­‰é”®ã€‚
- **è¯·æ±‚ä½“**ï¼š

```json
{
  "studentId": "s_123",
  "teacherId": "t_123",
  "subject": "math",
  "scheduledTime": "2025-08-22T01:00:00Z",
  "durationMinutes": 30,
  "idempotencyKey": "s_123-t_123-2025-08-22T01:00:00Z"
}
```

- **å“åº” 201**ï¼š

```json
{
  "id": "a_456",
  "status": "approved",
  "approvalRequired": false
}
```

- **é”™è¯¯**ï¼š`SUBJECT_MISMATCH`ã€`SLOT_TAKEN`ã€`QUOTA_EXCEEDED`ã€`MAX_DAILY_REACHED`ã€`IDEMPOTENT_CONFLICT`ã€`BAD_REQUEST`ã€‚

### 5.1.3 å–æ¶ˆé¢„çº¦

- **PATCH** `/api/appointments/{id}`
- **è¯·æ±‚ä½“**ï¼š`{ "action": "cancel", "reason": "è®¡åˆ’å†²çª" }`
- **å“åº” 200**ï¼š`{ "ok": true }`
- **é”™è¯¯**ï¼š`STATE_CONFLICT`ï¼ˆå¦‚å·² completed/expiredï¼‰ã€`FORBIDDEN`ï¼ˆè¶Šæƒï¼‰ã€‚

### 5.1.4 æˆ‘çš„é¢„çº¦åˆ—è¡¨

- **GET** `/api/appointments?role=student&studentId={id}&status={pending|approved|...}&from=&to=&cursor=&limit=`
- **å“åº” 200**ï¼š

```json
{
  "items": [
    {
      "id": "a_1",
      "scheduledTime": "...",
      "status": "approved"
    }
  ],
  "nextCursor": "eyJpZCI6..."
}
```

### 5.1.5 æ”¹æœŸï¼ˆé»˜è®¤ï¼šå–æ¶ˆ+æ–°å»ºï¼‰

- å…ˆè°ƒç”¨ **5.1.3** å–æ¶ˆï¼Œå†è°ƒç”¨ **5.1.2** åˆ›å»ºæ–°é¢„çº¦ï¼›
- ï¼ˆå¯é€‰ï¼‰å°†æ¥æä¾› `/api/appointments/{id}/reschedule` ä¸€æ­¥åˆ°ä½æ¥å£ã€‚

---

## 5.2 æ•™å¸ˆç«¯æ¥å£ï¼ˆTeacher APIsï¼‰

> é‰´æƒï¼šBearer JWTï¼ˆrole=teacherï¼‰ã€‚ä»…èƒ½æ“ä½œè‡ªå·±çš„èµ„æºã€‚

### 5.2.1 ç»´æŠ¤æ¯å‘¨å¯ç”¨æ€§

- **GET** `/api/teachers/{id}/availability`
- **POST** `/api/teachers/{id}/availability`
- **POST è¯·æ±‚ä½“**ï¼š

```json
{
  "dayOfWeek": 1,
  "startTime": "09:00",
  "endTime": "12:00",
  "isRecurring": true
}
```

- **å“åº” 200**ï¼š`{ "ok": true }`

### 5.2.2 ç»´æŠ¤é˜»å¡æ—¶é—´

- **POST** `/api/blocked-times`
- **è¯·æ±‚ä½“**ï¼š

```json
{
  "teacherId": "t_123",
  "startTime": "2025-08-22T02:00:00Z",
  "endTime": "2025-08-22T04:00:00Z",
  "reason": "Dept meeting"
}
```

- **å“åº” 200**ï¼š`{ "ok": true }`

### 5.2.3 å®¡æ‰¹/æ‹’ç»é¢„çº¦

- **PATCH** `/api/appointments/{id}`
- **è¯·æ±‚ä½“**ï¼š`{ "action": "approve" }` æˆ– `{ "action": "cancel", "reason": "ä¸åˆé€‚" }`
- **å“åº” 200**ï¼š`{ "ok": true }`
- **é”™è¯¯**ï¼š`STATE_CONFLICT`ï¼ˆå½“å‰ä¸æ˜¯ pendingï¼‰ã€‚

### 5.2.4 æ•™å¸ˆè§†è§’é¢„çº¦åˆ—è¡¨

- **GET** `/api/appointments?role=teacher&teacherId={id}&status=&from=&to=&cursor=&limit=`

---

## 5.3 ç³»ç»Ÿä¸ç®¡ç†æ¥å£ï¼ˆSystem & Admin APIsï¼‰

> é‰´æƒï¼šBearer JWTï¼ˆrole=admin æˆ–åå°ä»»åŠ¡ä»¤ç‰Œï¼‰ã€‚

### 5.3.1 æœåŠ¡çº§åˆ«ç­–ç•¥

- PUT `/api/policies`
- è¯·æ±‚ä½“ï¼ˆæ‰¹é‡ upsertï¼‰ï¼š

```json
{
  "policies": [
    { "level": "level1", "monthlyAutoApprove": 2, "priority": false, "expireHours": 48, "reminderOffsets": "24,1" },
    { "level": "level2", "monthlyAutoApprove": 0, "priority": false, "expireHours": 48, "reminderOffsets": "24,1" },
    { "level": "premium", "monthlyAutoApprove": 10000, "priority": true, "expireHours": 48, "reminderOffsets": "24,1" }
  ]
}
```

- å“åº” 200ï¼š`{ "updated": 3, "policies": [...] }`

### 5.3.2 48 å°æ—¶å¾…å®¡æ‰¹è¿‡æœŸ Job

- **POST** `/api/jobs/expire-pending`
- **å“åº” 200**ï¼š`{ "updated": 12 }`

### 5.3.3 æœˆåˆé…é¢é‡ç½® Job

- **POST** `/api/jobs/reset-quota`
- **å“åº” 200**ï¼š`{ "updated": 245 }`

### 5.3.4 å¥åº·æ£€æŸ¥

- **GET** `/api/healthz` â†’ `200`

```json
{
  "ok": true,
  "time": "..."
}
```

### 5.3.5 å€™è¡¥é˜Ÿåˆ—

- å­¦ç”ŸåŠ å…¥å€™è¡¥ï¼š
  - POST `/api/waitlist`
  - è¯·æ±‚ä½“ï¼š
  ```json
  {
    "teacherId": "t_1",
    "date": "2025-08-22",
    "slot": "2025-08-22T01:00:00Z",
    "studentId": "s_1",
    "subject": "math"
  }
  ```
  - å“åº”ï¼ˆ201ï¼‰ï¼š`{ "id": "...", "position": 3 }`

- å­¦ç”Ÿç§»é™¤å€™è¡¥ï¼š
  - DELETE `/api/waitlist`
  - è¯·æ±‚ä½“ï¼š`{ "id": "waitlist_id", "studentId": "s_1" }`

- æŸ¥è¯¢å€™è¡¥ï¼š
  - GET `/api/waitlist?studentId=...` æˆ– `?teacherId=...`
  - GET `/api/waitlist/slot?teacherId=...&slot=...&studentId=...`ï¼ˆæ§½ä½è¯¦æƒ… + æˆ‘çš„æ’ä½ï¼‰

- ç³»ç»Ÿæ™‹å‡ï¼ˆå†…éƒ¨è°ƒç”¨ï¼‰ï¼š
  - POST `/api/waitlist/promote`ï¼ˆç”±é¢„çº¦å–æ¶ˆæˆ–å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œéœ€ä½œä¸šé‰´æƒï¼‰

- ç³»ç»Ÿä½œä¸šï¼š
  - POST `/api/jobs/cleanup-waitlist`ï¼ˆæ¸…ç†å·²å ç”¨æ§½ä½çš„æ®‹ç•™å€™è¡¥ï¼‰
  - POST `/api/jobs/expire-waitlist`ï¼ˆæ ‡è®°è¿‡æœŸå€™è¡¥å¹¶é€šçŸ¥å­¦ç”Ÿï¼‰

# å…­ã€ç³»ç»Ÿå®‰å…¨

- **è®¤è¯ä¸ä¼šè¯**
  - Access Token (JWT, 15m) + Refresh Token (30d, å¯è½®æ¢)ï¼Œå­˜æ”¾ HttpOnly+Secure Cookieã€‚
  - ä¿®æ”¹å¯†ç /é‡ç½®å¯†ç æ—¶åŠé”€å…¨éƒ¨ Refreshã€‚
- **å¯†ç ç­–ç•¥**
  - æœ€å°‘ 8 ä½ï¼Œå«å­—æ¯ä¸æ•°å­—ã€‚
- **é˜²æš´åŠ›ä¸é™æµ**
  - ç”Ÿäº§ç¯å¢ƒé‡‡ç”¨è¿›ç¨‹å†…è½»é‡é™æµä¸­é—´ä»¶ï¼ˆå¯æŒ‰éœ€åˆ‡æ¢ä¸º Redis å®ç°ï¼‰ï¼Œé˜²æ­¢æ˜æ˜¾æ»¥ç”¨ã€‚
- **é‚®ä»¶å®‰å…¨**
  - æ‰€æœ‰é‚®ä»¶ Token ä»…ä¿å­˜å“ˆå¸Œï¼Œå•æ¬¡ä½¿ç”¨ï¼ŒçŸ­æœŸæœ‰æ•ˆã€‚
- **å®¡è®¡ä¸RBAC**
  - æ‰€æœ‰æ•æ„Ÿæ“ä½œå†™ `audit_logs`ã€‚
  - ä¸¥æ ¼åŸºäº `role + scope` åš API æƒé™æ ¡éªŒã€‚

---

# ä¸ƒã€æœ¬åœ°å¼€å‘ä¸éƒ¨ç½²

## 7.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ

### å¿«é€Ÿå¼€å§‹

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/bigkrys/EducationalMeetingSchedulingSystem.git
cd EducationalMeetingSchedulingSystem

# ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è®¾ç½®ï¼ˆæ¨èï¼‰
./scripts/setup-local.sh        # macOS/Linux
scripts\setup-local.bat         # Windows

# æˆ–æ‰‹åŠ¨è®¾ç½®
pnpm install
cp env.local.example .env.local
node scripts/generate-secrets.js
pnpm db:generate
pnpm db:push
pnpm db:seed
pnpm dev
```

### ç¯å¢ƒè¦æ±‚

- **Node.js**: 18.x+
- **pnpm**: 8.x+
- **æ•°æ®åº“**: PostgreSQLï¼ˆå¼€å‘/ç”Ÿäº§ä¸€è‡´ï¼Œæ¨è Neon æˆ–æœ¬åœ° Dockerï¼‰

### è¯¦ç»†æ–‡æ¡£

- ğŸ“š [æœ¬åœ°å¼€å‘æŒ‡å—](LOCAL_DEVELOPMENT.md) - å®Œæ•´çš„æœ¬åœ°ç¯å¢ƒæ­å»ºæ•™ç¨‹
- ğŸ”‘ [å¯†é’¥ç”Ÿæˆè„šæœ¬](scripts/generate-secrets.js) - è‡ªåŠ¨ç”Ÿæˆå®‰å…¨å¯†é’¥
- ğŸš€ [éƒ¨ç½²æŒ‡å—](DEPLOYMENT.md) - Verceléƒ¨ç½²è¯¦ç»†æ­¥éª¤

## 7.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### Verceléƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# å®‰è£…Vercel CLI
npm i -g vercel

# éƒ¨ç½²
vercel --prod
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¿…éœ€ç¯å¢ƒå˜é‡
DATABASE_URL="postgresql://username:password@host:port/database"
JWT_SECRET="your-super-secret-jwt-key-here-32-chars-min"
JWT_REFRESH_SECRET="your-super-secret-refresh-key-here-32-chars-min"
NEXTAUTH_SECRET="your-nextauth-secret-here-32-chars-min"
NEXTAUTH_URL="https://your-project.vercel.app"
NODE_ENV="production"
NEXT_PUBLIC_APP_URL="https://your-project.vercel.app"
```

### æ•°æ®åº“æ¨è

- **å¼€å‘**: PostgreSQLï¼ˆNeon åˆ†æ”¯/æœ¬åœ° Dockerï¼‰
- **ç”Ÿäº§**: Neon / Supabase (PostgreSQL)

## 7.3 é¡¹ç›®ç»“æ„

```
edu-scheduler/
â”œâ”€â”€ src/                    # æºä»£ç 
â”‚   â”œâ”€â”€ app/               # Next.js App Router
â”‚   â”œâ”€â”€ components/        # Reactç»„ä»¶
â”‚   â”œâ”€â”€ lib/              # å·¥å…·åº“
â”‚   â””â”€â”€ types/            # TypeScriptç±»å‹
â”œâ”€â”€ prisma/               # æ•°æ®åº“é…ç½®
â”œâ”€â”€ scripts/              # å·¥å…·è„šæœ¬
â”œâ”€â”€ docs/                 # æ–‡æ¡£
â”œâ”€â”€ LOCAL_DEVELOPMENT.md  # æœ¬åœ°å¼€å‘æŒ‡å—
â”œâ”€â”€ DEPLOYMENT.md         # éƒ¨ç½²æŒ‡å—
â””â”€â”€ README.md             # é¡¹ç›®è¯´æ˜
```

---

# å…«ã€è´¡çŒ®æŒ‡å—

## 8.1 å¼€å‘æµç¨‹

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

## 8.2 ä»£ç è§„èŒƒ

- ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
- éµå¾ª ESLint è§„åˆ™
- ç¼–å†™æ¸…æ™°çš„æ³¨é‡Šå’Œæ–‡æ¡£
- æ·»åŠ é€‚å½“çš„æµ‹è¯•ç”¨ä¾‹

## 8.3 é—®é¢˜åé¦ˆ

- ä½¿ç”¨ [GitHub Issues](https://github.com/bigkrys/EducationalMeetingSchedulingSystem/issues) æŠ¥å‘Šé—®é¢˜
- æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå¤ç°æ­¥éª¤
- æ ‡æ³¨é—®é¢˜ç±»å‹ï¼ˆbug/feature/enhancementï¼‰

---

# ä¹ã€è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

---

# åã€è”ç³»æ–¹å¼

- **é¡¹ç›®åœ°å€**: [https://github.com/bigkrys/EducationalMeetingSchedulingSystem](https://github.com/bigkrys/EducationalMeetingSchedulingSystem)
- **åœ¨çº¿æ¼”ç¤º**: [https://EducationalMeetingSchedulingSystem-git-develop-bigkrys.vercel.app](https://EducationalMeetingSchedulingSystem-git-develop-bigkrys.vercel.app)
- **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/bigkrys/EducationalMeetingSchedulingSystem/issues)



# åä¸€ã€ å…³é”®ç®—æ³•å®ç°

## 11.1 ç”Ÿæˆå¯ç”¨æ—¶é—´æ®µç®—æ³•

### æ ¸å¿ƒç®—æ³•ï¼š`calculateAvailableSlots()`

**åŠŸèƒ½æè¿°**ï¼šæ ¹æ®æ•™å¸ˆçš„å¯ç”¨æ€§è®¾ç½®ã€é˜»å¡æ—¶é—´å’Œå·²æœ‰é¢„çº¦ï¼Œç”ŸæˆæŒ‡å®šæ—¥æœŸçš„å¯ç”¨æ—¶é—´æ®µåˆ—è¡¨ã€‚

**ç®—æ³•æµç¨‹**ï¼š

```typescript
async function calculateAvailableSlots(teacher: any, date: string, duration: number) {
  // 1. è·å–ç›®æ ‡æ—¥æœŸçš„æ˜ŸæœŸå‡ 
  const dayOfWeek = getDay(targetDate) // 0 = å‘¨æ—¥, 1 = å‘¨ä¸€, ...

  // 2. æŸ¥æ‰¾è¯¥æ—¥æœŸçš„å¯ç”¨æ—¶é—´è®¾ç½®
  const dayAvailability = teacher.availability.find((avail) => avail.dayOfWeek === dayOfWeek)

  // 3. ç”ŸæˆåŸºç¡€æ—¶é—´æ§½ï¼ˆæŒ‰ duration åˆ†é’Ÿåˆ‡ç‰‡ï¼‰
  const allSlots = generateTimeSlots(dayAvailability.startTime, dayAvailability.endTime, duration)

  // 4. è¿‡æ»¤å†²çªæ—¶é—´æ§½
  const availableSlots = filterConflictingSlots(allSlots, teacher, targetDate, duration)

  return availableSlots.map((slot) => slot.toISOString())
}
```

**å…³é”®æ­¥éª¤è¯¦è§£**ï¼š

1. **æ—¶é—´æ§½ç”Ÿæˆ**ï¼š

   ```typescript
   // ä» startTime åˆ° endTimeï¼ŒæŒ‰ duration åˆ†é’Ÿé—´éš”ç”Ÿæˆ
   while (currentTime < slotEnd) {
     allSlots.push(new Date(currentTime))
     currentTime = addMinutes(currentTime, duration)
   }
   ```

2. **å†²çªæ£€æµ‹**ï¼š
   - é˜»å¡æ—¶é—´å†²çªæ£€æµ‹
   - å·²æœ‰é¢„çº¦å†²çªæ£€æµ‹ï¼ˆåŒ…å«ç¼“å†²æ—¶é—´ï¼‰
   - è¶…å‡ºç»“æŸæ—¶é—´çš„æ§½ä½è¿‡æ»¤

3. **ç¼“å†²æ—¶é—´å¤„ç†**ï¼š
   ```typescript
   // æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰é¢„çº¦å†²çªï¼ˆåŒ…å«ç¼“å†²æ—¶é—´ï¼‰
   const bufferStart = addMinutes(slot, -teacher.bufferMinutes)
   const bufferEnd = addMinutes(slotEndTime, teacher.bufferMinutes)
   ```

**æ€§èƒ½ä¼˜åŒ–**ï¼š

- ç¼“å­˜æœºåˆ¶ï¼š5åˆ†é’Ÿ TTL ç¼“å­˜çƒ­é—¨æŸ¥è¯¢ç»“æœ
- æ‰¹é‡æŸ¥è¯¢ï¼šä¸€æ¬¡æ€§è·å–æ‰€æœ‰ç›¸å…³æ•°æ®
- å†…å­˜è¿‡æ»¤ï¼šåœ¨åº”ç”¨å±‚è¿›è¡Œæ—¶é—´å†²çªè®¡ç®—

## 11.2 æ•™å¸ˆå¯ç”¨æ€§å†²çªæ£€æµ‹ç®—æ³•

### æ ¸å¿ƒç®—æ³•ï¼š`detectAvailabilityConflicts()`

**åŠŸèƒ½æè¿°**ï¼šæ£€æµ‹æ•™å¸ˆè®¾ç½®å¯ç”¨æ—¶é—´æ—¶ä¸ç°æœ‰é¢„çº¦ã€é˜»å¡æ—¶é—´çš„å†²çªæƒ…å†µã€‚**é‡è¦ï¼šå†²çªæ£€æµ‹ä»…åœ¨åŒä¸€ä¸ªæ˜ŸæœŸå‡ å†…è¿›è¡Œï¼Œä¸åŒæ˜ŸæœŸå‡ çš„ç›¸åŒæ—¶é—´æ®µä¸ä¼šè¢«è®¤ä¸ºæ˜¯é‡å çš„ã€‚**

**å†²çªç±»å‹åˆ†ç±»**ï¼š

```typescript
interface TimeConflict {
  type:
    | 'exact_match'
    | 'overlap'
    | 'contained'
    | 'contains'
    | 'blocked_time'
    | 'appointment'
    | 'invalid_time'
  message: string
  existingSlot?: TeacherAvailability
  blockedTime?: BlockedTime
  appointment?: Appointment
  overlap?: string
}
```

**å†²çªæ£€æµ‹ç®—æ³•**ï¼š

1. **æ—¶é—´é‡å åˆ†æ**ï¼ˆä¿®æ­£åçš„å‡†ç¡®ç®—æ³•ï¼‰ï¼š

   ```typescript
   function analyzeTimeOverlap(start1: string, end1: string, start2: string, end2: string) {
     const s1 = timeToMinutes(start1),
       e1 = timeToMinutes(end1)
     const s2 = timeToMinutes(start2),
       e2 = timeToMinutes(end2)

     // æ²¡æœ‰é‡å çš„æƒ…å†µï¼š
     // 1. ç¬¬ä¸€ä¸ªæ—¶é—´æ®µå®Œå…¨åœ¨ç¬¬äºŒä¸ªæ—¶é—´æ®µä¹‹å‰ (e1 <= s2)
     // 2. ç¬¬äºŒä¸ªæ—¶é—´æ®µå®Œå…¨åœ¨ç¬¬ä¸€ä¸ªæ—¶é—´æ®µä¹‹å‰ (e2 <= s1)
     if (e1 <= s2 || e2 <= s1) {
       return { type: 'no_overlap' }
     }

     // å®Œå…¨åŒ¹é…
     if (s1 === s2 && e1 === e2) {
       return { type: 'exact_match' }
     }

     // åŒ…å«å…³ç³»ï¼šç¬¬ä¸€ä¸ªæ—¶é—´æ®µåŒ…å«ç¬¬äºŒä¸ªæ—¶é—´æ®µ
     if (s1 <= s2 && e1 >= e2) {
       return { type: 'contains' }
     }

     // åŒ…å«å…³ç³»ï¼šç¬¬äºŒä¸ªæ—¶é—´æ®µåŒ…å«ç¬¬ä¸€ä¸ªæ—¶é—´æ®µ
     if (s2 <= s1 && e2 >= e1) {
       return { type: 'contained' }
     }

     // éƒ¨åˆ†é‡å ï¼šä¸¤ä¸ªæ—¶é—´æ®µæœ‰äº¤é›†ä½†ä¸å®Œå…¨åŒ…å«
     const overlapStart = Math.max(s1, s2)
     const overlapEnd = Math.min(e1, e2)
     const overlapMinutes = overlapEnd - overlapStart

     return {
       type: 'overlap',
       overlap: `${minutesToTime(overlapStart)}-${minutesToTime(overlapEnd)}`,
       overlapMinutes,
     }
   }
   ```

2. **æ˜ŸæœŸå‡ é€»è¾‘**ï¼ˆå…³é”®ç‰¹æ€§ï¼‰ï¼š

   ```typescript
   // å†²çªæ£€æµ‹ä»…åœ¨åŒä¸€ä¸ªæ˜ŸæœŸå‡ å†…è¿›è¡Œ
   if (request.specificDate) {
     // æ£€æŸ¥å…·ä½“æ—¥æœŸçš„å†²çª
     const targetDate = new Date(request.specificDate)
     existingSlots = await prisma.teacherAvailability.findMany({
       where: {
         teacherId,
         dayOfWeek: targetDate.getDay(), // åªæŸ¥è¯¢åŒä¸€å¤©
         isActive: true,
       },
     })
   } else if (request.dayOfWeek !== undefined) {
     // æ£€æŸ¥å‘¨å¾ªç¯çš„å†²çª
     existingSlots = await prisma.teacherAvailability.findMany({
       where: {
         teacherId,
         dayOfWeek: request.dayOfWeek, // åªæŸ¥è¯¢åŒä¸€ä¸ªæ˜ŸæœŸå‡ 
         isActive: true,
       },
     })
   }
   ```

3. **é¢„çº¦å†²çªæ£€æµ‹**ï¼ˆè®¾ç½®å¯ç”¨æ€§æ—¶ï¼‰ï¼š

   ```typescript
   async function checkAppointmentConflicts(teacherId: string, request: AvailabilityRequest) {
     const appointments = await prisma.appointment.findMany({
       where: {
         teacherId,
         status: { in: ['pending', 'approved'] },
       },
     })

     // åªæ£€æŸ¥åŒä¸€æ˜ŸæœŸå‡ çš„é¢„çº¦å†²çª
     for (const appointment of appointments) {
       let shouldCheck = false

       if (request.dayOfWeek !== undefined) {
         const appointmentDay = appointment.scheduledTime.getDay()
         shouldCheck = appointmentDay === request.dayOfWeek
       }

       if (shouldCheck) {
         // ä½¿ç”¨ analyzeTimeOverlap è¿›è¡Œæ—¶é—´é‡å åˆ†æ
         const overlapAnalysis = analyzeTimeOverlap(
           appointmentStart,
           appointmentEnd,
           request.startTime,
           request.endTime
         )

         if (overlapAnalysis.type !== 'no_overlap') {
           // è®°å½•å†²çª
         }
       }
     }
   }
   ```

4. **é˜»å¡æ—¶é—´å†²çªæ£€æµ‹**ï¼š

   ```typescript
   async function checkBlockedTimeConflicts(teacherId: string, request: AvailabilityRequest) {
     const blockedTimes = await prisma.blockedTime.findMany({ where: { teacherId } })

     // æ£€æŸ¥æ˜¯å¦ä¸é˜»å¡æ—¶é—´å†²çªï¼ˆæŒ‰æ˜ŸæœŸå‡ åˆ†ç»„ï¼‰
     for (const blocked of blockedTimes) {
       let shouldCheck = false

       if (request.dayOfWeek !== undefined) {
         const blockedDay = blocked.startTime.getDay()
         shouldCheck = blockedDay === request.dayOfWeek
       }

       if (shouldCheck) {
         const overlapAnalysis = analyzeTimeOverlap(
           blockedStart,
           blockedEnd,
           request.startTime,
           request.endTime
         )

         if (overlapAnalysis.type !== 'no_overlap') {
           // è®°å½•å†²çª
         }
       }
     }
   }
   ```

**æ™ºèƒ½å†²çªè§£å†³**ï¼š

```typescript
function generateConflictSuggestions(conflicts: TimeConflict[], request: AvailabilityRequest) {
  const suggestions = []

  for (const conflict of conflicts) {
    if (conflict.type === 'overlap' && conflict.existingSlot) {
      // è®¡ç®—åˆå¹¶åçš„æ—¶é—´æ®µ
      const mergedStart = minutesToTime(
        Math.min(timeToMinutes(existing.startTime), timeToMinutes(request.startTime))
      )
      const mergedEnd = minutesToTime(
        Math.max(timeToMinutes(existing.endTime), timeToMinutes(request.endTime))
      )

      suggestions.push({
        action: 'merge',
        description: `åˆå¹¶æ—¶é—´æ®µï¼šå°†æ‚¨çš„æ—¶é—´ä¸ç°æœ‰æ—¶é—´åˆå¹¶`,
        result: `${mergedStart}-${mergedEnd}`,
        recommendation: 'æ¨èï¼šè¿™æ ·å¯ä»¥æœ€å¤§åŒ–æ‚¨çš„å¯ç”¨æ—¶é—´ï¼Œé¿å…æ—¶é—´ç¢ç‰‡åŒ–',
      })
    } else if (conflict.type === 'exact_match') {
      suggestions.push({
        action: 'update',
        description: `æ›´æ–°ç°æœ‰æ—¶é—´æ®µï¼šä¿®æ”¹é‡å¤æ—¶é—´æ®µçš„è®¾ç½®`,
        recommendation: 'æ‚¨å¯ä»¥æ›´æ–°ç°æœ‰æ—¶é—´æ®µçš„é‡å¤è®¾ç½®æˆ–å…¶ä»–å±æ€§',
      })
    }
  }

  return suggestions.sort((a, b) => (a.priority || 999) - (b.priority || 999))
}
```

## 11.3 å­¦ç”Ÿé¢„çº¦å†²çªæ£€æµ‹ç®—æ³•

### æ ¸å¿ƒç®—æ³•ï¼šé¢„çº¦åˆ›å»ºæ—¶çš„å†²çªæ£€æµ‹

**åŠŸèƒ½æè¿°**ï¼šåœ¨åˆ›å»ºæ–°é¢„çº¦æ—¶ï¼Œæ£€æµ‹ä¸æ•™å¸ˆå¯ç”¨æ€§ã€é˜»å¡æ—¶é—´å’Œå·²æœ‰é¢„çº¦çš„æ—¶é—´å†²çªã€‚

**å†²çªæ£€æµ‹æµç¨‹**ï¼š

1. **æ•™å¸ˆå¯ç”¨æ€§æ£€æŸ¥**ï¼š

   ```typescript
   // æ£€æŸ¥æ•™å¸ˆåœ¨è¯¥æ—¥æœŸæ˜¯å¦æœ‰å¯ç”¨æ—¶é—´
   const dayOfWeek = appointmentDate.getDay()
   const dayAvailability = teacher.availability.find(
     (avail) => avail.dayOfWeek === dayOfWeek && avail.isActive
   )

   if (!dayAvailability) {
     throw new Error('æ•™å¸ˆåœ¨è¯¥æ—¥æœŸæ²¡æœ‰å¯ç”¨æ—¶é—´')
   }

   // æ£€æŸ¥é¢„çº¦æ—¶é—´æ˜¯å¦åœ¨å¯ç”¨æ—¶é—´èŒƒå›´å†…
   const appointmentStart = appointment.scheduledTime.toTimeString().slice(0, 5)
   const appointmentEnd = addMinutes(appointment.scheduledTime, duration).toTimeString().slice(0, 5)

   if (appointmentStart < dayAvailability.startTime || appointmentEnd > dayAvailability.endTime) {
     throw new Error('é¢„çº¦æ—¶é—´è¶…å‡ºæ•™å¸ˆçš„å¯ç”¨æ—¶é—´èŒƒå›´')
   }
   ```

2. **é˜»å¡æ—¶é—´å†²çªæ£€æµ‹**ï¼š

   ```typescript
   const blockedTimes = await prisma.blockedTime.findMany({
     where: { teacherId: teacher.id },
   })

   const hasBlockedTimeConflict = blockedTimes.some((blocked) => {
     const blockStart = blocked.startTime
     const blockEnd = blocked.endTime
     const appointmentEnd = addMinutes(appointment.scheduledTime, duration)

     // æ£€æŸ¥æ—¶é—´é‡å 
     return appointment.scheduledTime < blockEnd && appointmentEnd > blockStart
   })
   ```

3. **å·²æœ‰é¢„çº¦å†²çªæ£€æµ‹**ï¼ˆåŒ…å«ç¼“å†²æ—¶é—´ï¼‰ï¼š

   ```typescript
   const existingAppointments = await prisma.appointment.findMany({
     where: {
       teacherId: teacher.id,
       scheduledTime: {
         gte: startOfDay(appointmentDate),
         lt: endOfDay(appointmentDate),
       },
       status: { in: ['pending', 'approved'] },
     },
   })

   const hasConflict = existingAppointments.some((existing) => {
     const existingEnd = addMinutes(existing.scheduledTime, existing.durationMinutes)
     const appointmentEnd = addMinutes(appointment.scheduledTime, duration)

     // åŒ…å«ç¼“å†²æ—¶é—´çš„å†²çªæ£€æµ‹
     const bufferStart = addMinutes(appointment.scheduledTime, -teacher.bufferMinutes)
     const bufferEnd = addMinutes(appointmentEnd, teacher.bufferMinutes)

     return bufferStart < existingEnd && bufferEnd > existing.scheduledTime
   })
   ```

**è¾¹ç•Œæƒ…å†µå¤„ç†**ï¼š

- **ç¼“å†²æ—¶é—´**ï¼šæ•™å¸ˆè®¾ç½®çš„ `bufferMinutes` ç¡®ä¿é¢„çº¦é—´æœ‰è¶³å¤Ÿé—´éš”
- **çŠ¶æ€è¿‡æ»¤**ï¼šåªæ£€æŸ¥ `pending` å’Œ `approved` çŠ¶æ€çš„é¢„çº¦
- **æ—¶é—´ç²¾åº¦**ï¼šä½¿ç”¨æ¯«ç§’çº§ç²¾åº¦è¿›è¡Œæ—¶é—´æ¯”è¾ƒ
- **æ˜ŸæœŸå‡ é€»è¾‘**ï¼šé¢„çº¦æ—¶é—´å¿…é¡»ä¸æ•™å¸ˆçš„å¯ç”¨æ€§è®¾ç½®åŒ¹é…

## 12.4 æ—¶é—´é‡å æ£€æµ‹ç®—æ³•æ€»ç»“

### æ ¸å¿ƒç‰¹æ€§

1. **æ˜ŸæœŸå‡ éš”ç¦»**ï¼šä¸åŒæ˜ŸæœŸå‡ çš„æ—¶é—´æ®µä¸ä¼šè¢«è®¤ä¸ºæ˜¯é‡å çš„
2. **ç²¾ç¡®é‡å æ£€æµ‹**ï¼šä½¿ç”¨ä¿®æ­£åçš„ç®—æ³•å‡†ç¡®åˆ¤æ–­æ—¶é—´é‡å ç±»å‹
3. **ç¼“å†²æ—¶é—´æ”¯æŒ**ï¼šæ”¯æŒæ•™å¸ˆè‡ªå®šä¹‰çš„ç¼“å†²æ—¶é—´è®¾ç½®
4. **æ™ºèƒ½å†²çªè§£å†³**ï¼šæä¾›åˆå¹¶ã€åˆ†å‰²ç­‰å†²çªè§£å†³å»ºè®®

### ç®—æ³•å¤æ‚åº¦

- **æ—¶é—´å¤æ‚åº¦**ï¼šO(nÂ²) å…¶ä¸­ n æ˜¯æ—¶é—´æ®µæ•°é‡
- **ç©ºé—´å¤æ‚åº¦**ï¼šO(n) ç”¨äºå­˜å‚¨æ—¶é—´æ®µå’Œå†²çªä¿¡æ¯
- **ç¼“å­˜ä¼˜åŒ–**ï¼šçƒ­é—¨æŸ¥è¯¢ç»“æœç¼“å­˜5åˆ†é’Ÿï¼Œæ˜¾è‘—æå‡æ€§èƒ½

### å®é™…åº”ç”¨åœºæ™¯

1. **æ•™å¸ˆè®¾ç½®å¯ç”¨æ€§**ï¼šæ£€æµ‹ä¸ç°æœ‰æ—¶é—´æ®µçš„å†²çª
2. **å­¦ç”Ÿé¢„çº¦**ï¼šæ£€æµ‹ä¸æ•™å¸ˆå¯ç”¨æ€§å’Œé˜»å¡æ—¶é—´çš„å†²çª
3. **ç³»ç»Ÿç»´æŠ¤**ï¼šè‡ªåŠ¨è¿‡æœŸå¤„ç†ã€é…é¢é‡ç½®ç­‰å®šæ—¶ä»»åŠ¡


# åäºŒã€ ç”Ÿäº§è½åœ°è®¾è®¡æ–¹æ¡ˆ

ä» MVP åŠ å›ºåˆ°å®‰å…¨å‘å¸ƒçš„è½åœ°æ–¹æ¡ˆä¸æ“ä½œè¦ç‚¹ã€‚

## 12.1 æ€»è§ˆ

- ç›®æ ‡ç¯å¢ƒï¼šå¼€å‘ â†’ é¢„å‘ï¼ˆStaging/Previewï¼‰ â†’ ç”Ÿäº§ï¼ˆProductionï¼‰ ï¼ˆå·²å®Œæˆï¼‰
- å¹³å°ï¼šGitHub Actions + Vercelï¼ˆServerless + Cronï¼‰+ Neonï¼ˆPostgresï¼‰+ å¯é€‰ Redis ï¼ˆå·²å®Œæˆï¼‰
- å¯è§‚æµ‹æ€§ï¼šSentryï¼ˆé”™è¯¯ã€æ€§èƒ½ã€ä¸šåŠ¡æŒ‡æ ‡ï¼‰ã€ç»“æ„åŒ–æ—¥å¿—ã€å¥åº·æ£€æŸ¥ ï¼ˆå·²å®Œæˆï¼‰
- å®‰å…¨ä¸ç¨³å®šï¼šè¾“å…¥æ ¡éªŒã€ç»Ÿä¸€å“åº”ã€æƒé™ä¸é€Ÿç‡é™åˆ¶ã€CORS ç™½åå•ä¸å®‰å…¨å“åº”å¤´ã€ä½œä¸šæˆæƒã€DB è¿ç§»ã€å¤‡ä»½
- å®‰å…¨å‘å¸ƒï¼šé—¨ç¦ï¼ˆä»… main/develop éƒ¨ç½²ï¼‰ã€PR æ£€æŸ¥ã€ç”Ÿäº§æ‰‹åŠ¨è¿ç§»ã€ç°åº¦ç­–ç•¥ä¸å¿«é€Ÿå›æ»š ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰


## 12.2  MVP åŠ å›º

- è¾“å…¥å…¨è¦†ç›–æ ¡éªŒï¼š
  - ç¯å¢ƒå˜é‡æ ¡éªŒï¼š`src/lib/env.ts` ä½¿ç”¨ Zod å®šä¹‰ schemaï¼Œç”Ÿäº§ä¸‹å¤±è´¥å³æŠ›é”™ï¼ˆå·²å®Œæˆï¼‰
  - API å…¥å‚æ ¡éªŒï¼š`src/lib/api/validation.ts` + å„è·¯ç”± `zod.parse`/`withValidation`ï¼ˆå·²å®Œæˆï¼‰

- ç»Ÿä¸€ API å“åº”ï¼š
  - `ok()/fail()`ï¼š`src/lib/api/response.ts` ç»Ÿä¸€ `{ ok, error, message, details }`ï¼ˆå·²å®Œæˆï¼‰
  - é”™è¯¯é›†ä¸­å¤„ç†ï¼šè·¯ç”± try/catch + Sentry ä¸ŠæŠ¥ï¼ˆå·²å®Œæˆï¼‰

- é¢„çº¦ä¸€è‡´æ€§ï¼š
  - å”¯ä¸€çº¦æŸï¼š`@@unique([teacherId, scheduledTime])`ã€`idempotencyKey @unique`ï¼ˆå·²å®Œæˆï¼‰
  - äº‹åŠ¡ï¼šåˆ›å»ºé¢„çº¦ä½¿ç”¨äº‹åŠ¡ä¸å†²çª/é…é¢æ ¡éªŒï¼ˆå·²å®Œæˆï¼‰
  - å¹‚ç­‰ï¼š`idempotencyKey` é‡è¯•å®‰å…¨ï¼ˆå·²å®Œæˆï¼‰

- Cron Job åŠ å›ºï¼ˆäº‹åŠ¡/å¹‚ç­‰/æˆæƒï¼‰ï¼š
  - ä½œä¸šé‰´æƒï¼š`authorizeJobRequest()`ï¼ˆSecret + å¯é€‰ HMAC + ç”Ÿäº§é™„åŠ çº¦æŸï¼‰ï¼ˆå·²å®Œæˆï¼‰
  - ä»»åŠ¡ç¤ºä¾‹ï¼šè¿‡æœŸæ¸…ç†/æé†’/å€™è¡¥æå‡ï¼Œå«å¹¶å‘çª—å£ä¸å®¡è®¡ï¼ˆå·²å®Œæˆï¼‰

- CORS/å®‰å…¨å“åº”å¤´/è¯·æ±‚æ ‡è¯†ï¼š
  - `src/middleware.ts` æŒ‰ç™½åå•æ”¾è¡Œã€é™„åŠ å®‰å…¨å¤´ã€è´¯ç©¿ `x-request-id`ï¼ˆå·²å®Œæˆï¼‰

- é€Ÿç‡é™åˆ¶ï¼š
  - `withRateLimit()` ç”Ÿäº§ç”Ÿæ•ˆï¼Œç™»å½•/é¢„çº¦/æŸ¥è¯¢ç­‰è·¯ç”±å·²å¯ç”¨ï¼ˆå·²å®Œæˆï¼‰

- å¥åº·æ£€æŸ¥ï¼š
  - `GET /api/healthz` æ£€æŸ¥ DB/ç¼“å­˜/é‚®ä»¶è¿æ¥ï¼ˆå¯å¼€å…³ï¼‰ï¼ˆå·²å®Œæˆï¼‰

- å·¥å…·é“¾ä¸ä»£ç è´¨é‡ï¼š
  - TypeScript ä¸¥æ ¼æ¨¡å¼ã€ESLint/Prettierã€Husky pre-commitï¼ˆå·²å®Œæˆï¼‰


## 12.3 æ„å»ºé—¨ç¦ç³»ç»Ÿï¼ˆCI/CDï¼‰

- ç›®æ ‡ï¼š
  - PR åªè·‘æ£€æŸ¥ï¼ˆç±»å‹/æ„å»º/æµ‹è¯•ï¼‰ï¼Œä¸éƒ¨ç½²ï¼ˆå·²å®Œæˆï¼‰
  - develop â†’ Staging/Previewï¼Œè‡ªåŠ¨è¿ç§» Staging DBï¼ˆå·²å®Œæˆï¼‰
  - main â†’ Productionï¼Œç”Ÿäº§è¿ç§»ç»å·¥ä½œæµæ‰§è¡Œï¼ˆå·²å®Œæˆï¼‰

- æ£€æŸ¥é—¨ç¦ï¼š
  - `ci.yml` çš„ `checks` åœ¨ PR ä¸ `main/develop` æ¨é€æ—¶æ‰§è¡Œç±»å‹/ESLint/æµ‹è¯•ï¼ˆå·²å®Œæˆï¼‰

- è§¦å‘çŸ©é˜µï¼š
  - PRï¼ˆä»»æ„ â†’ develop/mainï¼‰ï¼šè·‘ CI æ£€æŸ¥ï¼ˆæ— éƒ¨ç½²ï¼‰ï¼ˆå·²å®Œæˆï¼‰
  - Push åˆ° developï¼šè¿ç§» Staging DB â†’ éƒ¨ç½² Previewï¼ˆè¾“å‡º URLï¼‰ï¼ˆå·²å®Œæˆï¼‰
  - å‘å¸ƒåˆ° Productionï¼š
    - åˆå¹¶ `develop â†’ main`ï¼ˆå·²å®Œæˆï¼‰
    - æ‰‹åŠ¨ç‚¹å·¥ä½œæµæ‰§è¡Œç”Ÿäº§ DB è¿ç§»ï¼ˆå·²å®Œæˆï¼‰
    - Vercel ç›‘æ§ `main` å˜åŒ–è‡ªåŠ¨æ„å»ºç”Ÿäº§

- å¹³å°é…ç½®è¦ç‚¹ï¼š
  - Vercelï¼ˆé¡¹ç›® Settings â†’ Git/Envï¼‰ï¼šæŒ‰ç¯å¢ƒé…ç½®å˜é‡ï¼›`vercel.json` æä¾›é—¨ç¦è„šæœ¬å ä½
  - GitHub ä¿æŠ¤åˆ†æ”¯ï¼šä¿æŠ¤ `main`/`develop`ã€è¦æ±‚çŠ¶æ€æ£€æŸ¥
  - GitHub Secretsï¼š`VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID`, `NEON_STAGING_URL`, `NEON_PROD_URL`


## 12.4 æ•°æ®åº“è¿ç§»ç­–ç•¥

- è¿ç§»ç›®çš„ï¼šå°† `prisma/schema.prisma` ç”Ÿæˆçš„è¿ç§»ç‰ˆæœ¬å¯é åœ°åº”ç”¨è‡³å„ç¯å¢ƒï¼ˆå·²å®Œæˆï¼‰
- ä¸€è‡´æ€§ä¿éšœï¼šPreview/Staging ä¸ Production ä¿æŒåŒä¸€æ‰¹è¿ç§»ç‰ˆæœ¬ï¼ˆå·²å®Œæˆï¼‰
- æµç¨‹å®šä½ï¼šdevelop å…ˆè¿ç§» Stagingï¼›main åˆå¹¶åé€šè¿‡å·¥ä½œæµè¿ç§»ç”Ÿäº§ï¼ˆå·²å®Œæˆï¼‰


## 12.5 å¯è§‚æµ‹æ€§ï¼ˆç›‘æ§/æ—¥å¿—/æŒ‡æ ‡ï¼‰

- Sentryï¼šæœåŠ¡ç«¯/å®¢æˆ·ç«¯é…ç½®ã€`withSentryRoute` å°è£…ã€ä¸šåŠ¡ `metrics.increment`ï¼ˆå·²å®Œæˆï¼‰
- ç»“æ„åŒ–æ—¥å¿—ï¼š`src/lib/logger.ts`ï¼ˆåŒ…å« `requestId` ç­‰å…³é”®å­—æ®µï¼‰ï¼ˆå·²å®Œæˆï¼‰
- å¥åº·æ£€æŸ¥ä¸ç³»ç»Ÿé¢æ¿ï¼š`/api/healthz`ã€ç®¡ç†ç«¯ Dashboardï¼ˆå·²å®Œæˆï¼‰


## 12.6 å®‰å…¨æ€§ä¸ç¨³å®šæ€§

- æƒé™ä¸è®¤è¯ï¼š`withAuth/withRole(s)` + JWTï¼Œæœ€å°æƒé™æš´éœ²ï¼ˆå·²å®Œæˆï¼‰
- é€Ÿç‡é™åˆ¶ï¼šç”Ÿäº§ç”Ÿæ•ˆçš„ `withRateLimit()`ï¼ˆå·²å®Œæˆï¼‰
- CORS ç™½åå•ä¸å®‰å…¨å“åº”å¤´ï¼š`src/middleware.ts`ï¼ˆå·²å®Œæˆï¼‰
- ä½œä¸šä¸è®¡åˆ’ä»»åŠ¡å®‰å…¨ï¼š`authorizeJobRequest()` + `vercel.json` Cronï¼ˆå·²å®Œæˆï¼‰
- æ¼æ´æ‰«æä¸ä¾èµ–å®‰å…¨ï¼šCI å¢åŠ  CodeQL/`pnpm audit`ï¼ˆæœªè½åœ°ï¼‰
- æ•°æ®å¤‡ä»½ï¼šNeon PITR/è‡ªåŠ¨å¤‡ä»½ä¸æ¢å¤æ¼”ç»ƒï¼ˆæœªè½åœ°ï¼‰


## 12.7 æ€§èƒ½ä¼˜åŒ–

- æŸ¥è¯¢ä¼˜åŒ–ï¼šé¢„çº¦åˆ—è¡¨ `take + cursor`ï¼Œé¿å…å¤§åç§»ï¼ˆå·²å®Œæˆï¼‰
- ç¼“å­˜ï¼šå†…å­˜/Redis åŒé€šé“ + æ¨¡å¼å¤±æ•ˆï¼ˆå·²å®Œæˆï¼‰
- Serverless å‚æ•°ï¼š`functions.maxDuration`ã€`regions` æŒ‡å®šï¼ˆå·²å®Œæˆï¼‰
- å¹¶å‘ä¸æ‰¹å¤„ç†ï¼šJob åˆ†é¡µ + å¹¶å‘çª—å£æ§åˆ¶ï¼ˆå·²å®Œæˆï¼‰

---

## 12.8 å®‰å…¨å‘å¸ƒç­–ç•¥ï¼ˆç°åº¦ä¸å›æ»šï¼‰ï¼ˆvercelç¯å¢ƒå·²é…ç½®è¯¥åŠŸèƒ½ï¼Œ éœ€è´­ä¹°ä¸“ä¸šç‰ˆï¼‰

- ç°åº¦å‘å¸ƒï¼šFeature Flag/é‡‘ä¸é›€åŸŸå/æŒ‰æ¯”ä¾‹æ”¾é‡ï¼ˆæœªè½åœ°--vercel ä¸“ä¸šç‰ˆå¸¦æœ‰æ»šåŠ¨å‘å¸ƒè®¾ç½®ï¼Œå°šæœªè´­ä¹°ä¸“ä¸šç‰ˆä½¿ç”¨ï¼Œ æ–‡æ¡£åœ°å€ https://vercel.com/docs/rolling-releases#configuring-rolling-releasesï¼‰
- ä¸€é”®å›æ»šï¼šVercel æä¾›Production å³æ—¶å›æ»šåŠŸèƒ½

---

## ç¯å¢ƒå˜é‡æ¸…å•ï¼ˆå…³é”®é¡¹ï¼‰

- åº”ç”¨ï¼š`NEXT_PUBLIC_APP_URL`ã€`ALLOWED_ORIGINS`
- æ•°æ®åº“ï¼š`DATABASE_URL`ï¼ˆGitHub Secretsï¼š`NEON_STAGING_URL`/`NEON_PROD_URL`ï¼‰
- JWTï¼š`JWT_SECRET`ã€`JWT_REFRESH_SECRET`
- ç¼“å­˜ï¼š`REDIS_URL`
- ä»»åŠ¡ï¼š`JOB_TRIGGER_SECRET`ã€`JOB_REQUIRE_HMAC`ã€`JOB_HMAC_WINDOW_SECONDS`ã€`JOB_ALLOWED_IPS`ã€`JOB_SCHEDULER_HEADER_NAME`ã€`JOB_SCHEDULER_HEADER_VALUE`
- Sentryï¼š`NEXT_PUBLIC_SENTRY_DSN`ã€`SENTRY_DSN`ã€é‡‡æ ·ç‡ç›¸å…³
- Vercel/GitHubï¼š`VERCEL_TOKEN`ã€`VERCEL_ORG_ID`ã€`VERCEL_PROJECT_ID`

---

## æ—¥å¸¸åä½œæµç¨‹

1. ä» `develop` åˆ‡ `feature/*` å¼€å‘ â†’ æ PR â†’ é€šè¿‡ CI â€œchecksâ€ ååˆå¹¶è‡³ `develop`
2. åˆå¹¶åˆ° `develop` â†’ è‡ªåŠ¨è¿ç§» Staging DB + éƒ¨ç½² Previewï¼ˆè¾“å‡º URLï¼‰â†’ åœ¨ Staging éªŒè¯åŠŸèƒ½ä¸æŒ‡æ ‡
3. éªŒè¯é€šè¿‡ â†’ æ PR `develop â†’ main` â†’ åˆå¹¶ååœ¨ Actions è¿è¡Œç”Ÿäº§è¿ç§» â†’ Vercel ç”Ÿäº§éƒ¨ç½²
